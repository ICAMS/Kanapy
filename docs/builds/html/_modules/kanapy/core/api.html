

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>kanapy.core.api &mdash; kanapy 6.5.3.post1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=53ab5b41"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            kanapy
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../applications.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../method.html">Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kanapy.html">Code documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../history.html">History</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">kanapy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">kanapy.core.api</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for kanapy.core.api</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot; Module defining class Microstructure that contains the necessary</span>
<span class="sd">methods and attributes to analyze experimental microstructures in form</span>
<span class="sd">of EBSD maps to generate statistical descriptors for 3D microstructures, and </span>
<span class="sd">to create synthetic RVE that fulfill the required statistical microstructure</span>
<span class="sd">descriptors.</span>

<span class="sd">The methods of the class Microstructure for an API that can be used to generate</span>
<span class="sd">Python workflows.</span>

<span class="sd">Authors: Alexander Hartmaier, Golsa Tolooei Eshlghi, Abhishek Biswas</span>
<span class="sd">Institution: ICAMS, Ruhr University Bochum</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">platform</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.spatial</span><span class="w"> </span><span class="kn">import</span> <span class="n">Delaunay</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">importlib.metadata</span><span class="w"> </span><span class="kn">import</span> <span class="n">version</span> <span class="k">as</span> <span class="n">pkg_version</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.grains</span><span class="w"> </span><span class="kn">import</span> <span class="n">calc_polygons</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.entities</span><span class="w"> </span><span class="kn">import</span> <span class="n">Simulation_Box</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.input_output</span><span class="w"> </span><span class="kn">import</span> <span class="n">export2abaqus</span><span class="p">,</span> <span class="n">writeAbaqusMat</span><span class="p">,</span> <span class="n">read_dump</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.initializations</span><span class="w"> </span><span class="kn">import</span> <span class="n">RVE_creator</span><span class="p">,</span> <span class="n">mesh_creator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.packing</span><span class="w"> </span><span class="kn">import</span> <span class="n">packingRoutine</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.voxelization</span><span class="w"> </span><span class="kn">import</span> <span class="n">voxelizationRoutine</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.smoothingGB</span><span class="w"> </span><span class="kn">import</span> <span class="n">smoothingRoutine</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.rve_stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_stats_vox</span><span class="p">,</span> <span class="n">get_stats_part</span><span class="p">,</span> <span class="n">get_stats_poly</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.plotting</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_init_stats</span><span class="p">,</span> <span class="n">plot_voxels_3D</span><span class="p">,</span> <span class="n">plot_ellipsoids_3D</span><span class="p">,</span> \
    <span class="n">plot_polygons_3D</span><span class="p">,</span> <span class="n">plot_output_stats</span><span class="p">,</span> <span class="n">plot_particles_3D</span>


<div class="viewcode-block" id="Microstructure">
<a class="viewcode-back" href="../../../kanapy.html#kanapy.core.api.Microstructure">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Microstructure</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Define class for synthetic microstructures</span>

<span class="sd">    Attributes:</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of microstructure</span>
<span class="sd">        nphases : int</span>
<span class="sd">            Number of phases in microstructure</span>
<span class="sd">        ngrains : ndarray</span>
<span class="sd">            Array of grain number in each phase</span>
<span class="sd">        Ngr : int</span>
<span class="sd">            Total number of grains summed over all phases</span>
<span class="sd">        nparticles : list</span>
<span class="sd">            List with number of particles in each phase</span>
<span class="sd">        descriptor : list</span>
<span class="sd">            List of dictionaries describing the microstructure of each phase;</span>
<span class="sd">            Dict Keys: &quot;Grains type&quot;, &quot;Equivalent diameter&quot;, &quot;Aspect ratio&quot;, &quot;Tilt Angle&quot;, &quot;RVE&quot;, &quot;Simulation&quot;</span>
<span class="sd">        precipit : None or float</span>
<span class="sd">            Indicates microstructure with precipitates/pores/particles in continuous matrix. If type is float,</span>
<span class="sd">             it gives volume the fraction of that precipitate phase</span>
<span class="sd">        from_voxels : bool</span>
<span class="sd">            Indicates whether microstructure object is imported from voxel file, not generated from particle simulation</span>
<span class="sd">        particles : list</span>
<span class="sd">            List of particle objects of class entities containing information object particle geometries</span>
<span class="sd">        rve : object of class RVE_creator</span>
<span class="sd">            Contains information about the RVE</span>
<span class="sd">            Attributes: dim, size, nparticles, periodic, units, packing_steps, particle_data,</span>
<span class="sd">            phase_names, phase_vf, ialloy</span>
<span class="sd">        simbox : Object of class Simulation_Box</span>
<span class="sd">            Contains information about geometry of simulation box for particle simulation</span>
<span class="sd">        mesh : object of class mesh_creator</span>
<span class="sd">            Attributes: dim, grain_dict, grain_ori_dict, grain_phase_dict, grains, ngrains_phase. nodes, nodes_smooth,</span>
<span class="sd">                nvox, phases, prec_vf_voxels, vox_center_dict, voxel_dict</span>
<span class="sd">        geometry : dict</span>
<span class="sd">            Dictionary of grain geometries;</span>
<span class="sd">            Dict keys: &quot;Vertices&quot;, &quot;Points&quot;, &quot;Simplices&quot;, &quot;Facets&quot;, &quot;Grains&quot;, &quot;GBnodes&quot;, GBarea&quot; &quot;GBfaces&quot;</span>
<span class="sd">            &quot;Grains&quot; : dictionary with key grain_number  </span>
<span class="sd">            Keys:&quot;Vertices&quot;, &quot;Points&quot;, &quot;Center&quot;, &quot;Simplices&quot;, &quot;Volume&quot;, &quot;Area&quot;, &quot;Phase&quot;, &quot;eqDia&quot;, &quot;majDia&quot;, &quot;minDia&quot;</span>
<span class="sd">        rve_stats : list</span>
<span class="sd">            List of dictionaries containing statistical information on different RVE types: particles, voxels,</span>
<span class="sd">            polyhedral grains</span>
<span class="sd">        rve_stats_labels : list</span>
<span class="sd">            List of strings containing the labels for the RVE types, i.e. Partcls, Voxels, Grains</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">descriptor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Microstructure&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nphases</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngrains</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nparticles</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precipit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rve</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particles</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simbox</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rve_stats</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rve_stats_labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">from_voxels</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ialloy</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vf_vox</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">descriptor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Please provide either a dictionary with statistics or an data file name&#39;</span><span class="p">)</span>

            <span class="c1"># Open the user data statistics file and read the data</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">file</span><span class="p">))</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;An unexpected exception occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;File: &#39;</span><span class="si">{}</span><span class="s2">&#39; does not exist in the current working directory!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">descriptor</span> <span class="o">==</span> <span class="s1">&#39;from_voxels&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">from_voxels</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">descriptor</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span> <span class="o">=</span> <span class="p">[</span><span class="n">descriptor</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nphases</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span> <span class="o">=</span> <span class="n">descriptor</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nphases</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nphases</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Kanapy is only tested for 2 phases, use at own risk for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nphases</span><span class="si">}</span><span class="s1"> phases&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;WARNING: Input parameter (descriptor) and file are given. Only descriptor will be used.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nphases</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s1">&#39;Phase&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">vf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Phase&#39;</span><span class="p">][</span><span class="s1">&#39;Volume fraction&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">vf</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="c1"># consider precipitates/pores/particles with volume fraction fill_factor in a matrix</span>
                <span class="c1"># precipitates will be phase 0, matrix phase will get number 1 and be assigned to grain with ID 0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">precipit</span> <span class="o">=</span> <span class="n">vf</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nphases</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Only one phase with volume fraction </span><span class="si">{</span><span class="n">vf</span><span class="si">}</span><span class="s1"> is given.&#39;</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Will consider a sparse distribution in a matrix phase with phase number 1, &#39;</span> <span class="o">+</span>
                             <span class="s1">&#39;which will be assigned to grain with ID 0.&#39;</span><span class="p">)</span>
        <span class="k">return</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --------        Routines for user interface        --------</span>
<span class="sd">    &quot;&quot;&quot;</span>


<div class="viewcode-block" id="Microstructure.init_RVE">
<a class="viewcode-back" href="../../../kanapy.html#kanapy.core.api.Microstructure.init_RVE">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">init_RVE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">descriptor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates particle distribution inside simulation box (RVE) based on</span>
<span class="sd">        the data provided in the data file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        descriptor</span>
<span class="sd">        nsteps</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">descriptor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">descriptor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">descriptor</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">descriptor</span> <span class="o">=</span> <span class="p">[</span><span class="n">descriptor</span><span class="p">]</span>

        <span class="c1"># initialize RVE, including mesh dimensions and particle distribution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rve</span> <span class="o">=</span> <span class="n">RVE_creator</span><span class="p">(</span><span class="n">descriptor</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">=</span><span class="n">nsteps</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">precipit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">phase_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Matrix&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">phase_vf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">precipit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nparticles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">nparticles</span>
        <span class="c1"># store geometry in simbox object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simbox</span> <span class="o">=</span> <span class="n">Simulation_Box</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">size</span><span class="p">)</span></div>


<div class="viewcode-block" id="Microstructure.pack">
<a class="viewcode-back" href="../../../kanapy.html#kanapy.core.api.Microstructure.pack">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">particle_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">k_rep</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">k_att</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">fill_factor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">poly</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_files</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot; Packs the particles into a simulation box.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">particle_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">particle_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">particle_data</span>
            <span class="k">if</span> <span class="n">particle_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No particle_data in pack. Run create_RVE first.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fill_factor</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">precipit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fill_factor</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># pack to full volume fraction defined in particles</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sparse particles (precipitates/pores): &#39;</span>
                  <span class="sa">f</span><span class="s1">&#39;Packing up to particle volume fraction of </span><span class="si">{</span><span class="p">(</span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">precipit</span><span class="p">)</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">precipit</span> <span class="o">&gt;</span> <span class="mf">0.65</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Overlap of particles will occur since volume fraction &gt; 65%&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">simbox</span> <span class="o">=</span> \
            <span class="n">packingRoutine</span><span class="p">(</span><span class="n">particle_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">periodic</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">packing_steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">simbox</span><span class="p">,</span>
                           <span class="n">k_rep</span><span class="o">=</span><span class="n">k_rep</span><span class="p">,</span> <span class="n">k_att</span><span class="o">=</span><span class="n">k_att</span><span class="p">,</span> <span class="n">fill_factor</span><span class="o">=</span><span class="n">fill_factor</span><span class="p">,</span>
                           <span class="n">poly</span><span class="o">=</span><span class="n">poly</span><span class="p">,</span> <span class="n">save_files</span><span class="o">=</span><span class="n">save_files</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span></div>


<div class="viewcode-block" id="Microstructure.voxelize">
<a class="viewcode-back" href="../../../kanapy.html#kanapy.core.api.Microstructure.voxelize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">voxelize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">particles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Generates the RVE by assigning voxels to grains.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">particles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">particles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span>
            <span class="k">if</span> <span class="n">particles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No particles in voxelize. Run pack first.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">dim</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">tuple</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&quot;dim&quot; must be a 3-tuple of the voxel numbers in each direction, not </span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="n">dim</span>

        <span class="c1"># initialize voxel structure (= mesh)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh_creator</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nphases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nphases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">create_voxels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simbox</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> \
            <span class="n">voxelizationRoutine</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nphases</span><span class="p">,</span> <span class="n">prec_vf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">precipit</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nparticles</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">ngrains_phase</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of grains per phase changed from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nparticles</span><span class="si">}</span><span class="s1"> to &#39;</span> <span class="o">+</span>
                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">ngrains_phase</span><span class="p">)</span><span class="si">}</span><span class="s1"> during voxelization.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngrains</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">ngrains_phase</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ngr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">ngrains_phase</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="c1"># extract volume fractions from voxelized grains</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nphases</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vf_vox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nphases</span><span class="p">)</span>
            <span class="n">vox_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nphases</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">igr</span><span class="p">,</span> <span class="n">ip</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grain_phase_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">vox_count</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grain_dict</span><span class="p">[</span><span class="n">igr</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Volume fractions of phases in voxel structure:&#39;</span><span class="p">)</span>
            <span class="n">vt</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nphases</span><span class="p">):</span>
                <span class="n">vf_act</span> <span class="o">=</span> <span class="n">vox_count</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nvox</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vf_vox</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">=</span> <span class="n">vf_act</span>
                <span class="n">vt</span> <span class="o">+=</span> <span class="n">vf_act</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">phase_names</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="p">(</span><span class="n">vf_act</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">%)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">vt</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Volume fractions of phases in voxels do not add up to 1. Value: </span><span class="si">{</span><span class="n">vt</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vf_vox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># remove grain information if it already exists to avoid inconsistencies</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Removing polyhedral grain geometries and statistical data after re-meshing.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Microstructure.smoothen">
<a class="viewcode-back" href="../../../kanapy.html#kanapy.core.api.Microstructure.smoothen">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">smoothen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes_v</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">voxel_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grain_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Generates smoothed grain boundary from a voxelated mesh.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">nodes_v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nodes_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span>
            <span class="k">if</span> <span class="n">nodes_v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No nodes_v in smoothen. Run voxelize first.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">voxel_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">voxel_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">voxel_dict</span>
        <span class="k">if</span> <span class="n">grain_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">grain_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grain_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nodes_smooth</span><span class="p">,</span> <span class="n">grain_facesDict</span> <span class="o">=</span> \
            <span class="n">smoothingRoutine</span><span class="p">(</span><span class="n">nodes_v</span><span class="p">,</span> <span class="n">voxel_dict</span><span class="p">,</span> <span class="n">grain_dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="s1">&#39;GBfaces&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grain_facesDict</span></div>


<div class="viewcode-block" id="Microstructure.generate_grains">
<a class="viewcode-back" href="../../../kanapy.html#kanapy.core.api.Microstructure.generate_grains">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_grains</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Writes out the particle- and grain diameter attributes for</span>
<span class="sd">        statistical comparison. Final RVE grain volumes and shared grain</span>
<span class="sd">        boundary surface areas info are written out as well.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grains</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No information about voxelized microstructure. Run voxelize first.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">precipit</span> <span class="ow">and</span> <span class="mi">0</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grain_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># in case of precipit, remove irregular grain 0 from analysis</span>
            <span class="n">empty_vox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grain_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">grain_store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grain_phase_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">empty_vox</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">grain_store</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> \
            <span class="n">calc_polygons</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>  <span class="c1"># updates RVE_data</span>
        <span class="c1"># verify that geometry[&#39;Grains&#39;] and mesh.grain_dict are consistent</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;if np.any(self.geometry[&#39;Ngrains&#39;] != self.ngrains):</span>
<span class="sd">            logging.warning(f&#39;Only facets for {self.geometry[&quot;Ngrains&quot;]} created, but {self.Ngr} grains in voxels.&#39;)</span>
<span class="sd">            for igr in self.mesh.grain_dict.keys():</span>
<span class="sd">                if igr not in self.geometry[&#39;Grains&#39;].keys():</span>
<span class="sd">                    logging.warning(f&#39;Grain: {igr} not in geometry. Be aware when creating GB textures.&#39;)&quot;&quot;&quot;</span>
        <span class="c1"># verify that geometry[&#39;GBarea&#39;] is consistent with geometry[&#39;Grains&#39;]</span>
        <span class="n">gba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="s1">&#39;GBarea&#39;</span><span class="p">]</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">igr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">gblist</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gba</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">gblist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="s1">&#39;Grains&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">igr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gblist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">gblist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="s1">&#39;Grains&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">igr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gblist</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span><span class="si">}</span><span class="s1"> grains are not represented in polyhedral geometry.&#39;</span><span class="p">)</span>
            <span class="c1"># logging.warning(&#39;Consider increasing the number of voxels, as grains appear to be very irregular.&#39;)</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;ind.reverse()</span>
<span class="sd">            igr.reverse()</span>
<span class="sd">            for j, i in enumerate(ind):</span>
<span class="sd">                logging.warning(f&#39;Removing {gba[i]} from GBarea as grain {igr[j]} does not exist.&#39;)</span>
<span class="sd">                gba.pop(i)</span>
<span class="sd">            self.geometry[&#39;GBarea&#39;] = gba&quot;&quot;&quot;</span>
        <span class="c1"># extract volume fractions from polyhedral grains</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nphases</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ph_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nphases</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">igr</span><span class="p">,</span> <span class="n">grd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="s1">&#39;Grains&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">ip</span> <span class="o">=</span> <span class="n">grd</span><span class="p">[</span><span class="s1">&#39;Phase&#39;</span><span class="p">]</span>
                <span class="n">ph_vol</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">+=</span> <span class="n">grd</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Volume fractions of phases in polyhedral geometry:&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nphases</span><span class="p">):</span>
                <span class="n">vf</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">ph_vol</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">phase_names</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">vf</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s1">%)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">empty_vox</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># add removed grain again</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grain_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">empty_vox</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grain_phase_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">grain_store</span></div>


<div class="viewcode-block" id="Microstructure.generate_orientations">
<a class="viewcode-back" href="../../../kanapy.html#kanapy.core.api.Microstructure.generate_orientations">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_orientations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">ang</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">omega</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Nbase</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
                              <span class="n">hist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shared_area</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">iphase</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the orientations of grains to give a desired crystallographic texture</span>
<span class="sd">        for the number of grains in RVE.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data</span>
<span class="sd">        ang</span>
<span class="sd">        omega</span>
<span class="sd">        Nbase</span>
<span class="sd">        hist</span>
<span class="sd">        shared_area</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">kanapy</span><span class="w"> </span><span class="kn">import</span> <span class="n">__backend__</span>
        <span class="k">if</span> <span class="n">__backend__</span> <span class="o">==</span> <span class="s1">&#39;mtex&#39;</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">kanapy_mtex.texture</span><span class="w"> </span><span class="kn">import</span> <span class="n">EBSDmap</span><span class="p">,</span> <span class="n">createOrisetRandom</span><span class="p">,</span> <span class="n">createOriset</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using MTEX library to read EBSD maps and generate orientations.&#39;</span><span class="p">)</span>
            <span class="n">MTEX</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">kanapy.texture</span><span class="w"> </span><span class="kn">import</span> <span class="n">EBSDmap</span><span class="p">,</span> <span class="n">createOrisetRandom</span><span class="p">,</span> <span class="n">createOriset</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using ORIX library to read EBSD maps and generate orientations.&#39;</span><span class="p">)</span>
            <span class="n">MTEX</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grains</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Grain geometry is not defined. Run voxelize first.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">shared_area</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">gba</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;If histogram for GB texture is provided, GB areas must be defined.</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                                     <span class="s1">&#39;Run generate_grains() first, to calculate GB areas.&#39;</span><span class="p">)</span>
                <span class="n">gba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="s1">&#39;GBarea&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">shared_area</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">gba</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gba</span> <span class="o">=</span> <span class="n">shared_area</span>

        <span class="n">ori_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">ngr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrains</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">EBSDmap</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">iphase</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">iphase</span> <span class="o">==</span> <span class="n">ip</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">gba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">MTEX</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Shared are is currently only available in kanapy-mtex.</span><span class="se">\n</span><span class="s1">&#39;</span>
                                        <span class="s1">&#39;This option will be ignored.&#39;</span><span class="p">)</span>
                        <span class="n">gba</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">ori_rve</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">calcORI</span><span class="p">(</span><span class="n">ngr</span><span class="p">,</span> <span class="n">iphase</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span> <span class="n">shared_area</span><span class="o">=</span><span class="n">gba</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">texture</span> <span class="o">=</span> <span class="s2">&quot;ODF&quot;</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;random&#39;</span><span class="p">,</span> <span class="s1">&#39;rnd&#39;</span><span class="p">]:</span>
                    <span class="n">ori_rve</span> <span class="o">=</span> <span class="n">createOrisetRandom</span><span class="p">(</span><span class="n">ngr</span><span class="p">,</span> <span class="n">Nbase</span><span class="o">=</span><span class="n">Nbase</span><span class="p">,</span> <span class="n">hist</span><span class="o">=</span><span class="n">hist</span><span class="p">,</span> <span class="n">shared_area</span><span class="o">=</span><span class="n">gba</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">texture</span> <span class="o">=</span> <span class="s2">&quot;Random&quot;</span>
                <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;unimodal&#39;</span><span class="p">,</span> <span class="s1">&#39;uni_mod&#39;</span><span class="p">,</span> <span class="s1">&#39;uni_modal&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">ang</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">omega</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;To generate orientation sets of type &quot;unimodal&quot; angle &quot;ang&quot; and kernel&#39;</span> <span class="o">+</span>
                                         <span class="s1">&#39;halfwidth &quot;omega&quot; are required.&#39;</span><span class="p">)</span>
                    <span class="n">ori_rve</span> <span class="o">=</span> <span class="n">createOriset</span><span class="p">(</span><span class="n">ngr</span><span class="p">,</span> <span class="n">ang</span><span class="p">,</span> <span class="n">omega</span><span class="p">,</span> <span class="n">hist</span><span class="o">=</span><span class="n">hist</span><span class="p">,</span> <span class="n">shared_area</span><span class="o">=</span><span class="n">gba</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">texture</span> <span class="o">=</span> <span class="s2">&quot;Unimodal&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">texture</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Argument to generate grain orientation must be either of type EBSDmap or &#39;</span> <span class="o">+</span>
                                 <span class="s1">&#39;&quot;random&quot; or &quot;unimodal&quot;&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">igr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grain_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grain_phase_dict</span><span class="p">[</span><span class="n">igr</span><span class="p">]</span> <span class="o">==</span> <span class="n">ip</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">iphase</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">iphase</span> <span class="o">==</span> <span class="n">ip</span><span class="p">:</span>
                        <span class="n">ind</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">ip</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngrains</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">ori_dict</span><span class="p">[</span><span class="n">igr</span><span class="p">]</span> <span class="o">=</span> <span class="n">ori_rve</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grain_ori_dict</span> <span class="o">=</span> <span class="n">ori_dict</span>
        <span class="k">return</span></div>


<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --------     Plotting methods          --------</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Microstructure.plot_ellipsoids">
<a class="viewcode-back" href="../../../kanapy.html#kanapy.core.api.Microstructure.plot_ellipsoids">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_ellipsoids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;prism&#39;</span><span class="p">,</span> <span class="n">dual_phase</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phases</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Generates plot of particles&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dual_phase</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Use of &quot;dual_phase&quot; is depracted. Use parameter &quot;phases&quot; instead.&#39;</span><span class="p">)</span>
            <span class="n">phases</span> <span class="o">=</span> <span class="n">dual_phase</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No particle to plot. Run pack first.&#39;</span><span class="p">)</span>
        <span class="n">hmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">asp_arr</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">hmin</span><span class="p">),</span>
                   <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">hmin</span><span class="p">),</span>
                   <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">hmin</span><span class="p">)]</span>
        <span class="n">plot_ellipsoids_3D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">phases</span><span class="o">=</span><span class="n">phases</span><span class="p">,</span> <span class="n">asp_arr</span><span class="o">=</span><span class="n">asp_arr</span><span class="p">)</span></div>


<div class="viewcode-block" id="Microstructure.plot_particles">
<a class="viewcode-back" href="../../../kanapy.html#kanapy.core.api.Microstructure.plot_particles">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_particles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;prism&#39;</span><span class="p">,</span> <span class="n">dual_phase</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phases</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_hull</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Generates plot of particles&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dual_phase</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Use of &quot;dual_phase&quot; is depracted. Use parameter &quot;phases&quot; instead.&#39;</span><span class="p">)</span>
            <span class="n">phases</span> <span class="o">=</span> <span class="n">dual_phase</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No particle to plot. Run pack first.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">inner</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Ellipsoids without inner polygon cannot be plotted.&#39;</span><span class="p">)</span>
        <span class="n">hmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">asp_arr</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">hmin</span><span class="p">),</span>
                   <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">hmin</span><span class="p">),</span>
                   <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">hmin</span><span class="p">)]</span>
        <span class="n">plot_particles_3D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                          <span class="n">phases</span><span class="o">=</span><span class="n">phases</span><span class="p">,</span> <span class="n">plot_hull</span><span class="o">=</span><span class="n">plot_hull</span><span class="p">,</span> <span class="n">asp_arr</span><span class="o">=</span><span class="n">asp_arr</span><span class="p">)</span></div>


<div class="viewcode-block" id="Microstructure.plot_voxels">
<a class="viewcode-back" href="../../../kanapy.html#kanapy.core.api.Microstructure.plot_voxels">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_voxels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sliced</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dual_phase</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phases</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;prism&#39;</span><span class="p">,</span> <span class="n">ori</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">color_key</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates plot of voxel structure</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sliced</span>
<span class="sd">        dual_phase</span>
<span class="sd">        cmap</span>
<span class="sd">        ori</span>
<span class="sd">        color_key: int</span>
<span class="sd">            selects the color key: 0: iphHSVKey, 1: BungeColorKey, 2: ipfHKLKey (optional, default: 0)</span>
<span class="sd">        silent</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dual_phase</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Use of &quot;dual_phase&quot; is depracted. Use parameter &quot;phases&quot; instead.&#39;</span><span class="p">)</span>
            <span class="n">phases</span> <span class="o">=</span> <span class="n">dual_phase</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grains</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No voxels or elements to plot. Run voxelize first.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">phases</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">phases</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grains</span>
        <span class="k">if</span> <span class="n">ori</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span><span class="w">  </span><span class="nn">kanapy</span><span class="w"> </span><span class="kn">import</span> <span class="n">__backend__</span>
            <span class="k">if</span> <span class="n">__backend__</span> <span class="o">==</span> <span class="s2">&quot;mtex&quot;</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">kanapy_mtex.texture</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_ipf_colors</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">kanapy.texture</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_ipf_colors</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ori</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ori</span><span class="p">:</span>
                <span class="n">ori</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grain_ori_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
            <span class="n">clist</span> <span class="o">=</span> <span class="n">get_ipf_colors</span><span class="p">(</span><span class="n">ori</span><span class="p">,</span> <span class="n">color_key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clist</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">hmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">asp_arr</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">hmin</span><span class="p">),</span>
                   <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">hmin</span><span class="p">),</span>
                   <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">hmin</span><span class="p">)]</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_voxels_3D</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sliced</span><span class="o">=</span><span class="n">sliced</span><span class="p">,</span>
                             <span class="n">phases</span><span class="o">=</span><span class="n">phases</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">clist</span><span class="o">=</span><span class="n">clist</span><span class="p">,</span>
                             <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">,</span> <span class="n">asp_arr</span><span class="o">=</span><span class="n">asp_arr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">silent</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="Microstructure.plot_grains">
<a class="viewcode-back" href="../../../kanapy.html#kanapy.core.api.Microstructure.plot_grains">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_grains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;prism&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
                    <span class="n">ec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dual_phase</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phases</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Plot polygonalized microstructure&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ec</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dual_phase</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Use of &quot;dual_phase&quot; is depracted. Use parameter &quot;phases&quot; instead.&#39;</span><span class="p">)</span>
            <span class="n">phases</span> <span class="o">=</span> <span class="n">dual_phase</span>
        <span class="k">if</span> <span class="n">geometry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">geometry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span>
        <span class="k">if</span> <span class="n">geometry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No polygons for grains defined. Run generate_grains() first&#39;</span><span class="p">)</span>
        <span class="n">hmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">asp_arr</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">hmin</span><span class="p">),</span>
                   <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">hmin</span><span class="p">),</span>
                   <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">hmin</span><span class="p">)]</span>
        <span class="n">plot_polygons_3D</span><span class="p">(</span><span class="n">geometry</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="n">ec</span><span class="p">,</span>
                         <span class="n">phases</span><span class="o">=</span><span class="n">phases</span><span class="p">,</span> <span class="n">asp_arr</span><span class="o">=</span><span class="n">asp_arr</span><span class="p">)</span></div>


<div class="viewcode-block" id="Microstructure.plot_stats">
<a class="viewcode-back" href="../../../kanapy.html#kanapy.core.api.Microstructure.plot_stats">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">gs_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gs_param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">ar_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ar_param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">dual_phase</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phases</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">save_files</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">show_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">enhanced_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Plots the particle- and grain diameter attributes for statistical </span>
<span class="sd">        comparison.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dual_phase</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Use of &quot;dual_phase&quot; is depracted. Use parameter &quot;phases&quot; instead.&#39;</span><span class="p">)</span>
            <span class="n">phases</span> <span class="o">=</span> <span class="n">dual_phase</span>
        <span class="k">if</span> <span class="n">silent</span><span class="p">:</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">show_all</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">enhanced_plot</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ax_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">phases</span><span class="p">:</span>
            <span class="n">nphases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nphases</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">precipit</span> <span class="ow">and</span> <span class="mi">0</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grain_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c1"># in case of precipit, remove irregular grain 0 from analysis</span>
                <span class="n">nphases</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nphases</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">gs_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">gs_data</span><span class="p">)</span> <span class="o">==</span> <span class="n">nphases</span><span class="p">):</span>
            <span class="n">gs_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">gs_data</span><span class="p">]</span> <span class="o">*</span> <span class="n">nphases</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">gs_param</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">gs_param</span><span class="p">)</span> <span class="o">==</span> <span class="n">nphases</span><span class="p">):</span>
            <span class="n">gs_param</span> <span class="o">=</span> <span class="p">[</span><span class="n">gs_param</span><span class="p">]</span> <span class="o">*</span> <span class="n">nphases</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ar_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ar_data</span><span class="p">)</span> <span class="o">==</span> <span class="n">nphases</span><span class="p">):</span>
            <span class="n">ar_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">ar_data</span><span class="p">]</span> <span class="o">*</span> <span class="n">nphases</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ar_param</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ar_param</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">gs_param</span><span class="p">)):</span>
            <span class="n">ar_param</span> <span class="o">=</span> <span class="p">[</span><span class="n">ar_param</span><span class="p">]</span> <span class="o">*</span> <span class="n">nphases</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        gs_data = [ebsd.ms_data[i][&#39;gs_data&#39;] for i in range(nphases)]</span>
<span class="sd">        gs_param = [ebsd.ms_data[i][&#39;gs_param&#39;] for i in range(nphases)]</span>
<span class="sd">        ar_data = [ebsd.ms_data[i][&#39;ar_data&#39;] for i in range(nphases)]</span>
<span class="sd">        ar_param = [ebsd.ms_data[i][&#39;ar_param&#39;] for i in range(nphases)]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">iphase</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">flist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nphases</span><span class="p">):</span>
            <span class="n">stats_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">phases</span><span class="p">:</span>
                <span class="n">iphase</span> <span class="o">=</span> <span class="n">ip</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Plotting statistical information for phase </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># Analyze and plot particles statistics</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> \
                    <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="ow">and</span> <span class="s1">&#39;p&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Particle statistics requested, but no particles defined. &#39;</span>
                                  <span class="s1">&#39;Run &quot;pack()&quot; first.&#39;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">part_stats</span> <span class="o">=</span> <span class="n">get_stats_part</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">,</span> <span class="n">iphase</span><span class="o">=</span><span class="n">iphase</span><span class="p">,</span> <span class="n">ax_max</span><span class="o">=</span><span class="n">ax_max</span><span class="p">,</span>
                                            <span class="n">show_plot</span><span class="o">=</span><span class="n">show_all</span><span class="p">,</span>
                                            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">save_files</span><span class="o">=</span><span class="n">save_files</span><span class="p">)</span>
                <span class="n">stats_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part_stats</span><span class="p">)</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Partcls&quot;</span><span class="p">)</span>

            <span class="c1"># Analyze and plot statistics of voxel structure in RVE</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> \
                    <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="ow">and</span> <span class="s1">&#39;v&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Voxel statistics requested, but no voxel mesh defined. &#39;</span>
                                  <span class="s1">&#39;Run &quot;voxelize()&quot; first.&#39;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">vox_stats</span> <span class="o">=</span> <span class="n">get_stats_vox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">iphase</span><span class="o">=</span><span class="n">iphase</span><span class="p">,</span> <span class="n">ax_max</span><span class="o">=</span><span class="n">ax_max</span><span class="p">,</span>
                                          <span class="n">show_plot</span><span class="o">=</span><span class="n">show_all</span><span class="p">,</span>
                                          <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">save_files</span><span class="o">=</span><span class="n">save_files</span><span class="p">)</span>
                <span class="n">stats_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vox_stats</span><span class="p">)</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Voxels&#39;</span><span class="p">)</span>

            <span class="c1"># Analyze and plot statistics of polyhedral grains in RVE</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> \
                    <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="ow">and</span> <span class="s1">&#39;g&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Geometry statistics requested, but no polyhedral grains defined. &#39;</span>
                                  <span class="s1">&#39;Run &quot;generate_grains()&quot; first.&#39;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">grain_stats</span> <span class="o">=</span> <span class="n">get_stats_poly</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="s1">&#39;Grains&#39;</span><span class="p">],</span> <span class="n">iphase</span><span class="o">=</span><span class="n">iphase</span><span class="p">,</span> <span class="n">ax_max</span><span class="o">=</span><span class="n">ax_max</span><span class="p">,</span>
                                             <span class="n">show_plot</span><span class="o">=</span><span class="n">show_all</span><span class="p">,</span> <span class="n">phase_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grain_phase_dict</span><span class="p">,</span>
                                             <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">save_files</span><span class="o">=</span><span class="n">save_files</span><span class="p">)</span>
                <span class="n">stats_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grain_stats</span><span class="p">)</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Grains&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">phases</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Statistical microstructure parameters of phase </span><span class="si">{</span><span class="n">iphase</span><span class="si">}</span><span class="s1"> in RVE&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------------------------&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Statistical microstructure parameters of RVE&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Type</span><span class="se">\t</span><span class="s1">| a (µm) </span><span class="se">\t</span><span class="s1">| b (µm) </span><span class="se">\t</span><span class="s1">| c (µm) </span><span class="se">\t</span><span class="s1">| std.dev</span><span class="se">\t</span><span class="s1">| rot.axis</span><span class="se">\t</span><span class="s1">| asp.ratio</span><span class="se">\t</span><span class="s1">| std.dev</span><span class="se">\t</span><span class="s1">|&#39;</span>
                  <span class="sa">f</span><span class="s1">&#39; equ.dia. (µm)</span><span class="se">\t</span><span class="s1">| std.dev&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sd</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stats_list</span><span class="p">):</span>
                <span class="n">av_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">sd</span><span class="p">[</span><span class="s1">&#39;a_sig&#39;</span><span class="p">],</span> <span class="n">sd</span><span class="p">[</span><span class="s1">&#39;b_sig&#39;</span><span class="p">],</span> <span class="n">sd</span><span class="p">[</span><span class="s1">&#39;c_sig&#39;</span><span class="p">]])</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="se">\t</span><span class="s1">|  </span><span class="si">{</span><span class="n">sd</span><span class="p">[</span><span class="s2">&quot;a_scale&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="se">\t</span><span class="s1">|  </span><span class="si">{</span><span class="n">sd</span><span class="p">[</span><span class="s2">&quot;b_scale&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="se">\t</span><span class="s1">|  </span><span class="si">{</span><span class="n">sd</span><span class="p">[</span><span class="s2">&quot;c_scale&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="se">\t</span><span class="s1">|  &#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">av_std</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="se">\t</span><span class="s1">|     </span><span class="si">{</span><span class="n">sd</span><span class="p">[</span><span class="s2">&quot;ind_rot&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">   </span><span class="se">\t</span><span class="s1">|  </span><span class="si">{</span><span class="n">sd</span><span class="p">[</span><span class="s2">&quot;ar_scale&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="se">\t</span><span class="s1">|  </span><span class="si">{</span><span class="n">sd</span><span class="p">[</span><span class="s2">&quot;ar_sig&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="se">\t</span><span class="s1">|     &#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sd</span><span class="p">[</span><span class="s2">&quot;eqd_scale&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> </span><span class="se">\t</span><span class="s1">|  </span><span class="si">{</span><span class="n">sd</span><span class="p">[</span><span class="s2">&quot;eqd_sig&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rve_stats</span> <span class="o">=</span> <span class="n">stats_list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rve_stats_labels</span> <span class="o">=</span> <span class="n">labels</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_output_stats</span><span class="p">(</span><span class="n">stats_list</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">iphase</span><span class="o">=</span><span class="n">iphase</span><span class="p">,</span>
                                    <span class="n">gs_data</span><span class="o">=</span><span class="n">gs_data</span><span class="p">[</span><span class="n">ip</span><span class="p">],</span> <span class="n">gs_param</span><span class="o">=</span><span class="n">gs_param</span><span class="p">[</span><span class="n">ip</span><span class="p">],</span>
                                    <span class="n">ar_data</span><span class="o">=</span><span class="n">ar_data</span><span class="p">[</span><span class="n">ip</span><span class="p">],</span> <span class="n">ar_param</span><span class="o">=</span><span class="n">ar_param</span><span class="p">[</span><span class="n">ip</span><span class="p">],</span>
                                    <span class="n">save_files</span><span class="o">=</span><span class="n">save_files</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">,</span>
                                    <span class="n">enhanced_plot</span><span class="o">=</span><span class="n">enhanced_plot</span><span class="p">)</span>
            <span class="n">flist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">silent</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">flist</span></div>


<div class="viewcode-block" id="Microstructure.plot_stats_init">
<a class="viewcode-back" href="../../../kanapy.html#kanapy.core.api.Microstructure.plot_stats_init">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_stats_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">descriptor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gs_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ar_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">porous</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">get_res</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_res</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">save_files</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_descriptors</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Plots initial statistical microstructure descriptors .&quot;&quot;&quot;</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">analyze_voxels</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">des</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;show_res is True, but no voxels have been defined. Run voxelize first.&#39;</span><span class="p">)</span>
            <span class="n">vox_stats</span> <span class="o">=</span> <span class="n">get_stats_vox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">iphase</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span> <span class="n">show_plot</span><span class="o">=</span><span class="n">show_res</span><span class="p">)</span>
            <span class="n">gsp</span> <span class="o">=</span> <span class="p">[</span><span class="n">vox_stats</span><span class="p">[</span><span class="s1">&#39;eqd_sig&#39;</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">vox_stats</span><span class="p">[</span><span class="s1">&#39;eqd_scale&#39;</span><span class="p">],</span>
                   <span class="nb">min</span><span class="p">(</span><span class="n">vox_stats</span><span class="p">[</span><span class="s1">&#39;eqd&#39;</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="n">vox_stats</span><span class="p">[</span><span class="s1">&#39;eqd&#39;</span><span class="p">])]</span>
            <span class="n">arp</span> <span class="o">=</span> <span class="p">[</span><span class="n">vox_stats</span><span class="p">[</span><span class="s1">&#39;ar_sig&#39;</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">vox_stats</span><span class="p">[</span><span class="s1">&#39;ar_scale&#39;</span><span class="p">],</span>
                   <span class="nb">min</span><span class="p">(</span><span class="n">vox_stats</span><span class="p">[</span><span class="s1">&#39;ar&#39;</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="n">vox_stats</span><span class="p">[</span><span class="s1">&#39;ar&#39;</span><span class="p">])]</span>
            <span class="k">if</span> <span class="s1">&#39;Grain type&#39;</span> <span class="ow">in</span> <span class="n">des</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">des</span><span class="p">[</span><span class="s1">&#39;Grain type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Elongated&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">nel</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Statistical microstructure parameters of phase </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s1"> in RVE&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------------------------&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Statistical microstructure parameters of RVE&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Type</span><span class="se">\t</span><span class="s1">| a (µm) </span><span class="se">\t</span><span class="s1">| b (µm) </span><span class="se">\t</span><span class="s1">| c (µm) </span><span class="se">\t</span><span class="s1">| std.dev</span><span class="se">\t</span><span class="s1">| rot.axis</span><span class="se">\t</span><span class="s1">| asp.ratio</span><span class="se">\t</span><span class="s1">| std.dev</span><span class="se">\t</span><span class="s1">|&#39;</span>
                      <span class="sa">f</span><span class="s1">&#39; equ.dia. (µm)</span><span class="se">\t</span><span class="s1">| std.dev&#39;</span><span class="p">)</span>

                <span class="n">av_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">vox_stats</span><span class="p">[</span><span class="s1">&#39;a_sig&#39;</span><span class="p">],</span> <span class="n">vox_stats</span><span class="p">[</span><span class="s1">&#39;b_sig&#39;</span><span class="p">],</span> <span class="n">vox_stats</span><span class="p">[</span><span class="s1">&#39;c_sig&#39;</span><span class="p">]])</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Input</span><span class="se">\t</span><span class="s1">|  -      </span><span class="se">\t</span><span class="s1">|  -      </span><span class="se">\t</span><span class="s1">|  -      </span><span class="se">\t</span><span class="s1">|   -      </span><span class="se">\t</span><span class="s1">|     -   </span><span class="se">\t</span><span class="s1">|  &#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">des</span><span class="p">[</span><span class="s2">&quot;Aspect ratio&quot;</span><span class="p">][</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="se">\t</span><span class="s1">|  </span><span class="si">{</span><span class="n">des</span><span class="p">[</span><span class="s2">&quot;Aspect ratio&quot;</span><span class="p">][</span><span class="s2">&quot;sig&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="se">\t</span><span class="s1">|     &#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">des</span><span class="p">[</span><span class="s2">&quot;Equivalent diameter&quot;</span><span class="p">][</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> </span><span class="se">\t</span><span class="s1">|  </span><span class="si">{</span><span class="n">des</span><span class="p">[</span><span class="s2">&quot;Equivalent diameter&quot;</span><span class="p">][</span><span class="s2">&quot;sig&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Output</span><span class="se">\t</span><span class="s1">|  </span><span class="si">{</span><span class="n">vox_stats</span><span class="p">[</span><span class="s2">&quot;a_scale&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="se">\t</span><span class="s1">|  </span><span class="si">{</span><span class="n">vox_stats</span><span class="p">[</span><span class="s2">&quot;b_scale&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="se">\t</span><span class="s1">|  &#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">vox_stats</span><span class="p">[</span><span class="s2">&quot;c_scale&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="se">\t</span><span class="s1">|  </span><span class="si">{</span><span class="n">av_std</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="se">\t</span><span class="s1">|     </span><span class="si">{</span><span class="n">vox_stats</span><span class="p">[</span><span class="s2">&quot;ind_rot&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">   </span><span class="se">\t</span><span class="s1">|  &#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">vox_stats</span><span class="p">[</span><span class="s2">&quot;ar_scale&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="se">\t</span><span class="s1">|  </span><span class="si">{</span><span class="n">vox_stats</span><span class="p">[</span><span class="s2">&quot;ar_sig&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="se">\t</span><span class="s1">|     &#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">vox_stats</span><span class="p">[</span><span class="s2">&quot;eqd_scale&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> </span><span class="se">\t</span><span class="s1">|  </span><span class="si">{</span><span class="n">vox_stats</span><span class="p">[</span><span class="s2">&quot;eqd_sig&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">statistical_descriptors</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;eqd&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">vox_stats</span><span class="p">[</span><span class="s1">&#39;eqd_scale&#39;</span><span class="p">]),</span>
                        <span class="s1">&#39;std&#39;</span><span class="p">:</span>  <span class="nb">float</span><span class="p">(</span><span class="n">vox_stats</span><span class="p">[</span><span class="s1">&#39;eqd_sig&#39;</span><span class="p">]),</span>
                        <span class="s1">&#39;min&#39;</span><span class="p">:</span>  <span class="nb">float</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">vox_stats</span><span class="p">[</span><span class="s1">&#39;eqd&#39;</span><span class="p">])),</span>
                        <span class="s1">&#39;max&#39;</span><span class="p">:</span>  <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">vox_stats</span><span class="p">[</span><span class="s1">&#39;eqd&#39;</span><span class="p">])),</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;ar&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">vox_stats</span><span class="p">[</span><span class="s1">&#39;ar_scale&#39;</span><span class="p">]),</span>
                        <span class="s1">&#39;std&#39;</span><span class="p">:</span>  <span class="nb">float</span><span class="p">(</span><span class="n">vox_stats</span><span class="p">[</span><span class="s1">&#39;ar_sig&#39;</span><span class="p">]),</span>
                        <span class="s1">&#39;min&#39;</span><span class="p">:</span>  <span class="nb">float</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">vox_stats</span><span class="p">[</span><span class="s1">&#39;ar&#39;</span><span class="p">])),</span>
                        <span class="s1">&#39;max&#39;</span><span class="p">:</span>  <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">vox_stats</span><span class="p">[</span><span class="s1">&#39;ar&#39;</span><span class="p">])),</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;axes&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">vox_stats</span><span class="p">[</span><span class="s1">&#39;a_scale&#39;</span><span class="p">]),</span>
                        <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">vox_stats</span><span class="p">[</span><span class="s1">&#39;b_scale&#39;</span><span class="p">]),</span>
                        <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">vox_stats</span><span class="p">[</span><span class="s1">&#39;c_scale&#39;</span><span class="p">]),</span>
                        <span class="s1">&#39;a_std&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">vox_stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a_sig&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)),</span>
                        <span class="s1">&#39;b_std&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">vox_stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b_sig&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)),</span>
                        <span class="s1">&#39;c_std&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">vox_stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;c_sig&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)),</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;rotation_axis&#39;</span><span class="p">:</span> <span class="n">vox_stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ind_rot&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="p">}</span>
            <span class="k">return</span> <span class="n">gsp</span><span class="p">,</span> <span class="n">arp</span><span class="p">,</span> <span class="n">statistical_descriptors</span>

        <span class="k">if</span> <span class="n">show_res</span><span class="p">:</span> <span class="n">get_res</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">silent</span><span class="p">:</span> <span class="n">show_res</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">descriptor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">descriptor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptor</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">descriptor</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="n">descriptor</span> <span class="o">=</span> <span class="p">[</span><span class="n">descriptor</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">porous</span><span class="p">:</span> <span class="n">descriptor</span> <span class="o">=</span> <span class="n">descriptor</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">nel</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">descriptor</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">gs_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">gs_data</span><span class="p">)</span> <span class="o">==</span> <span class="n">nel</span><span class="p">):</span> <span class="n">gs_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">gs_data</span><span class="p">]</span> <span class="o">*</span> <span class="n">nel</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ar_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ar_data</span><span class="p">)</span> <span class="o">==</span> <span class="n">nel</span><span class="p">):</span> <span class="n">ar_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">ar_data</span><span class="p">]</span> <span class="o">*</span> <span class="n">nel</span>

        <span class="n">flist</span><span class="p">,</span> <span class="n">descs</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">,</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">des</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">descriptor</span><span class="p">):</span>
            <span class="n">gsp</span> <span class="o">=</span> <span class="n">arp</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">statistical_descriptors</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">get_res</span><span class="p">:</span>
                <span class="n">gsp</span><span class="p">,</span> <span class="n">arp</span><span class="p">,</span> <span class="n">statistical_descriptors</span> <span class="o">=</span> <span class="n">analyze_voxels</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">des</span><span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_init_stats</span><span class="p">(</span><span class="n">des</span><span class="p">,</span> <span class="n">gs_data</span><span class="o">=</span><span class="n">gs_data</span><span class="p">[</span><span class="n">ip</span><span class="p">],</span> <span class="n">ar_data</span><span class="o">=</span><span class="n">ar_data</span><span class="p">[</span><span class="n">ip</span><span class="p">],</span>
                                  <span class="n">gs_param</span><span class="o">=</span><span class="n">gsp</span><span class="p">,</span> <span class="n">ar_param</span><span class="o">=</span><span class="n">arp</span><span class="p">,</span>
                                  <span class="n">save_files</span><span class="o">=</span><span class="n">save_files</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span>
            <span class="n">flist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">return_descriptors</span><span class="p">:</span>
                <span class="n">descs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;phase&#39;</span><span class="p">:</span> <span class="n">ip</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">statistical_descriptors</span> <span class="ow">or</span> <span class="p">{})})</span>

        <span class="k">if</span> <span class="n">return_descriptors</span> <span class="ow">or</span> <span class="n">silent</span><span class="p">:</span> <span class="k">return</span> <span class="n">flist</span><span class="p">,</span> <span class="n">descs</span></div>


<div class="viewcode-block" id="Microstructure.plot_slice">
<a class="viewcode-back" href="../../../kanapy.html#kanapy.core.api.Microstructure.plot_slice">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="s1">&#39;xy&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">dual_phase</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_files</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot a slice through the microstructure.</span>
<span class="sd">        </span>
<span class="sd">        If polygonalized microstructure is available, it will be used as data </span>
<span class="sd">        basis, otherwise or if data=&#39;voxels&#39; the voxelized microstructure </span>
<span class="sd">        will be plotted.</span>
<span class="sd">        </span>
<span class="sd">        This subroutine calls the output_ang function with plotting active </span>
<span class="sd">        and writing of ang file deactivated.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cut : str, optional</span>
<span class="sd">            Define cutting plane of slice as &#39;xy&#39;, &#39;xz&#39; or &#39;yz&#39;. The default is &#39;xy&#39;.</span>
<span class="sd">        data : str, optional</span>
<span class="sd">            Define data basis for plotting as &#39;voxels&#39; or &#39;poly&#39;. The default is None.</span>
<span class="sd">        pos : str or float</span>
<span class="sd">            Position in which slice is taken, either as absolute value, or as </span>
<span class="sd">            one of &#39;top&#39;, &#39;bottom&#39;, &#39;left&#39;, &#39;right&#39;. The default is None.</span>
<span class="sd">        fname : str, optional</span>
<span class="sd">            Filename of PDF file. The default is None.</span>
<span class="sd">        save_files : bool, optional</span>
<span class="sd">            Indicate if figure file is saved and PDF. The default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_ang</span><span class="p">(</span><span class="n">cut</span><span class="o">=</span><span class="n">cut</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_files</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="n">fname</span><span class="p">,</span> <span class="n">dual_phase</span><span class="o">=</span><span class="n">dual_phase</span><span class="p">,</span>
                        <span class="n">save_plot</span><span class="o">=</span><span class="n">save_files</span><span class="p">)</span></div>


<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --------        Import/Export methods        --------</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Microstructure.write_abq">
<a class="viewcode-back" href="../../../kanapy.html#kanapy.core.api.Microstructure.write_abq">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_abq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span> <span class="n">voxel_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grain_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">dual_phase</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">thermal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ialloy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nsdv</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">periodicBC</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">crystal_plasticity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">phase_props</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">apply_bc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes out the Abaqus deck (.inp file) for the generated RVE. The parameter nodes should be</span>
<span class="sd">        a string indicating if voxel (&quot;v&quot;) or smoothened (&quot;s&quot;) mesh should be written. It can also</span>
<span class="sd">        provide an array of nodal positions. If dual_phase is true, the</span>
<span class="sd">        generated deck contains plain material definitions for each phase. Material parameters must</span>
<span class="sd">        be specified by the user. If ialloy is provided, the generated deck material definitions</span>
<span class="sd">        for each grain. For dual phase structures to be used with crystal plasticity, ialloy</span>
<span class="sd">        can be a list with all required material definitions. If the list ialloy is shorter than the</span>
<span class="sd">        number of phases in the RVE, plain material definitions for the remaining phases will</span>
<span class="sd">        be included in the input deck.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nodes</span>
<span class="sd">        file</span>
<span class="sd">        path</span>
<span class="sd">        voxel_dict</span>
<span class="sd">        grain_dict</span>
<span class="sd">        dual_phase</span>
<span class="sd">        thermal</span>
<span class="sd">        units</span>
<span class="sd">        ialloy</span>
<span class="sd">        nsdv</span>
<span class="sd">        bc_type</span>
<span class="sd">        load_type</span>
<span class="sd">        loading_direction</span>
<span class="sd">        value</span>
<span class="sd">        apply_bc : bool, optional</span>
<span class="sd">            If True, boundary conditions are written to the Abaqus input file. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        file : str</span>
<span class="sd">            Path to the generated Abaqus input file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">nodes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nodes_smooth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;GBarea&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Warning: No argument &quot;nodes&quot; is given, will write smoothened structure&#39;</span><span class="p">)</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nodes_smooth</span>
                <span class="n">faces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="s1">&#39;GBarea&#39;</span><span class="p">]</span>
                <span class="n">ntag</span> <span class="o">=</span> <span class="s1">&#39;_smooth&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Warning: No argument &quot;nodes&quot; is given, will write voxelized structure&#39;</span><span class="p">)</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span>
                <span class="n">faces</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">ntag</span> <span class="o">=</span> <span class="s1">&#39;_voxels&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No information about voxelized microstructure. Run voxelize first.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">faces</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ntag</span> <span class="o">=</span> <span class="s1">&#39;_voxels&#39;</span>
        <span class="k">elif</span> <span class="n">nodes</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;smooth&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nodes_smooth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;GBarea&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nodes_smooth</span>
                <span class="n">faces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="s1">&#39;GBarea&#39;</span><span class="p">]</span>  <span class="c1"># use tet elements for smoothened structure</span>
                <span class="n">ntag</span> <span class="o">=</span> <span class="s1">&#39;_smooth&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No information about smoothed microstructure. Run smoothen first.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">nodes</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;voxels&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;voxel&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span>
                <span class="n">faces</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># use brick elements for voxel structure</span>
                <span class="n">ntag</span> <span class="o">=</span> <span class="s1">&#39;_voxels&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No information about voxelized microstructure. Run voxelize first.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Wrong value for parameter &quot;nodes&quot;. Must be either &quot;smooth&quot; &#39;</span> <span class="o">+</span>
                             <span class="sa">f</span><span class="s1">&#39;or &quot;voxels&quot;, not </span><span class="si">{</span><span class="n">nodes</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">voxel_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">voxel_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">voxel_dict</span>
        <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">units</span>
        <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;mm&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;um&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Units must be either &quot;mm&quot; or &quot;um&quot;, not </span><span class="si">{</span><span class="n">units</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dual_phase</span><span class="p">:</span>
            <span class="n">nct</span> <span class="o">=</span> <span class="s1">&#39;abq_dual_phase&#39;</span>
            <span class="k">if</span> <span class="n">grain_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">grain_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nphases</span><span class="p">):</span>
                    <span class="n">grain_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">igr</span><span class="p">,</span> <span class="n">ip</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grain_phase_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">grain_dict</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">grain_dict</span><span class="p">[</span><span class="n">ip</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grain_dict</span><span class="p">[</span><span class="n">igr</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">grain_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">grain_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grain_dict</span>
            <span class="n">nct</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;abq_px_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">grain_dict</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">ialloy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ialloy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">ialloy</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ialloy</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ialloy</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nphases</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;List of values in ialloy is larger than number of phases in RVE.&#39;</span> <span class="o">+</span>
                             <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ialloy</span><span class="p">)</span><span class="si">}</span><span class="s1"> &gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nphases</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nphases</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">grpd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grain_phase_dict</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">grpd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Microstructure&#39;</span><span class="p">:</span>
                <span class="n">file</span> <span class="o">=</span> <span class="n">nct</span> <span class="o">+</span> <span class="n">ntag</span> <span class="o">+</span> <span class="s1">&#39;_geom.inp&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="n">ntag</span> <span class="o">+</span> <span class="s1">&#39;_geom.inp&#39;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="n">periodic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">periodic</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">periodic</span> <span class="ow">and</span> <span class="n">periodicBC</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Periodic boundary conditions cannot be applied to a non-periodic RVE.&quot;</span><span class="p">)</span>

        <span class="n">export2abaqus</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">grain_dict</span><span class="p">,</span> <span class="n">voxel_dict</span><span class="p">,</span>
                      <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">gb_area</span><span class="o">=</span><span class="n">faces</span><span class="p">,</span>
                      <span class="n">dual_phase</span><span class="o">=</span><span class="n">dual_phase</span><span class="p">,</span>
                      <span class="n">ialloy</span><span class="o">=</span><span class="n">ialloy</span><span class="p">,</span> <span class="n">grain_phase_dict</span><span class="o">=</span><span class="n">grpd</span><span class="p">,</span>
                      <span class="n">thermal</span><span class="o">=</span><span class="n">thermal</span><span class="p">,</span>  <span class="n">periodicBC</span> <span class="o">=</span> <span class="n">periodicBC</span><span class="p">,</span>
                      <span class="n">crystal_plasticity</span> <span class="o">=</span> <span class="n">crystal_plasticity</span><span class="p">,</span>
                      <span class="n">phase_props</span> <span class="o">=</span> <span class="n">phase_props</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">apply_bc</span><span class="o">=</span><span class="n">apply_bc</span><span class="p">)</span>

        <span class="c1"># if orientations exist and ialloy is defined also write material file with Euler angles</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grain_ori_dict</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ialloy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">writeAbaqusMat</span><span class="p">(</span><span class="n">ialloy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grain_ori_dict</span><span class="p">,</span>
                           <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;mat.inp&#39;</span><span class="p">,</span>
                           <span class="n">grain_phase_dict</span><span class="o">=</span><span class="n">grpd</span><span class="p">,</span> <span class="n">nsdv</span><span class="o">=</span><span class="n">nsdv</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">file</span></div>


<div class="viewcode-block" id="Microstructure.write_abq_ori">
<a class="viewcode-back" href="../../../kanapy.html#kanapy.core.api.Microstructure.write_abq_ori">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_abq_ori</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ialloy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ori</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span> <span class="n">nsdv</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ialloy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ialloy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">ialloy</span>
            <span class="k">if</span> <span class="n">ialloy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Value of material number in ICAMS CP-UMAT (ialloy) not defined.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ori</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ori</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grain_ori_dict</span>
            <span class="k">if</span> <span class="n">ori</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No orientations present. Run &quot;generate_orientations&quot; first.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Microstructure&#39;</span><span class="p">:</span>
                <span class="n">file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;abq_px_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Ngr</span><span class="si">}</span><span class="s1">_mat.inp&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_mat.inp&#39;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="n">writeAbaqusMat</span><span class="p">(</span><span class="n">ialloy</span><span class="p">,</span> <span class="n">ori</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">,</span> <span class="n">nsdv</span><span class="o">=</span><span class="n">nsdv</span><span class="p">)</span></div>


<div class="viewcode-block" id="Microstructure.output_neper">
<a class="viewcode-back" href="../../../kanapy.html#kanapy.core.api.Microstructure.output_neper">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">output_neper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Writes out particle position and weights files required for</span>
<span class="sd">        tessellation in Neper.&quot;&quot;&quot;</span>
        <span class="c1"># write_position_weights(timestep)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No particle to plot. Run pack first.&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Writing position and weights files for NEPER&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">par_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">pa</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">z</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">a</span>
            <span class="n">par_dict</span><span class="p">[</span><span class="n">pa</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">a</span><span class="p">]</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;sphere_positions.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">par_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;sphere_weights.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">par_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;----&gt;DONE!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Microstructure.output_ang">
<a class="viewcode-back" href="../../../kanapy.html#kanapy.core.api.Microstructure.output_ang">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">output_ang</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ori</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="s1">&#39;xy&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">matname</span><span class="o">=</span><span class="s1">&#39;XXXX&#39;</span><span class="p">,</span> <span class="n">save_files</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">dual_phase</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert orientation information of microstructure into a .ang file,</span>
<span class="sd">        mimicking an EBSD map.</span>
<span class="sd">        If polygonalized microstructure is available, it will be used as data </span>
<span class="sd">        basis, otherwise or if data=&#39;voxels&#39; the voxelized microstructure </span>
<span class="sd">        will be exported.</span>
<span class="sd">        If no orientations are provided, each grain will get a random </span>
<span class="sd">        Euler angle.</span>
<span class="sd">        Values in ANG file:</span>
<span class="sd">        phi1 Phi phi2 X Y imageQuality confidenseIndex phase semSignal Fit(/mad)</span>
<span class="sd">        Output of ang file can be deactivated if called for plotting of slice.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ori : (self.Ngr, )-array, optional</span>
<span class="sd">            Euler angles of grains. The default is None.</span>
<span class="sd">        cut : str, optional</span>
<span class="sd">            Define cutting plane of slice as &#39;xy&#39;, &#39;xz&#39; or &#39;yz&#39;. The default is &#39;xy&#39;.</span>
<span class="sd">        data : str, optional</span>
<span class="sd">            Define data basis for plotting as &#39;voxels&#39; or &#39;poly&#39;. The default is None.</span>
<span class="sd">        plot : bool, optional</span>
<span class="sd">            Indicate if slice is plotted. The default is True.</span>
<span class="sd">        pos : str or float</span>
<span class="sd">            Position in which slice is taken, either as absolute value, or as </span>
<span class="sd">            one of &#39;top&#39;, &#39;bottom&#39;, &#39;left&#39;, &#39;right&#39;. The default is None.</span>
<span class="sd">        cs : str, Optional</span>
<span class="sd">            Crystal symmetry. Default is None</span>
<span class="sd">        fname : str, optional</span>
<span class="sd">            Filename of ang file. The default is None.</span>
<span class="sd">        matname : str, optional</span>
<span class="sd">            Name of the material to be written in ang file. The default is &#39;XXXX&#39;</span>
<span class="sd">        save_files : bool, optional</span>
<span class="sd">            Indicate if ang file is saved, The default is True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fname : str</span>
<span class="sd">            Name of ang file.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ori</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">ori</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">ori</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
        <span class="n">cut</span> <span class="o">=</span> <span class="n">cut</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">botlist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="s1">&#39;bot&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">]</span>
        <span class="n">toplist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cut</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span>
            <span class="n">sizeX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sizeY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">sz</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
            <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">iy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">toplist</span><span class="p">:</span>
                <span class="n">iz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">botlist</span><span class="p">:</span>
                <span class="n">iz</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
                <span class="n">iz</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pos</span> <span class="o">/</span> <span class="n">sz</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;&quot;pos&quot; must be either float or &quot;top&quot;, &quot;bottom&quot;, &quot;left&quot; or &quot;right&quot;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">iz</span> <span class="o">*</span> <span class="n">sz</span><span class="p">)</span>
            <span class="n">xl</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;x ($\mu$m)&#39;</span>
            <span class="n">yl</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;y ($\mu$m)&#39;</span>
            <span class="n">title</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;XY slice at z=</span><span class="si">{}</span><span class="s1"> $\mu$m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">iz</span> <span class="o">*</span> <span class="n">sz</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">cut</span> <span class="o">==</span> <span class="s1">&#39;xz&#39;</span><span class="p">:</span>
            <span class="n">sizeX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sizeY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">vox_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
            <span class="n">sx</span> <span class="o">=</span> <span class="n">vox_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sy</span> <span class="o">=</span> <span class="n">vox_res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">sz</span> <span class="o">=</span> <span class="n">vox_res</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">iy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">toplist</span><span class="p">:</span>
                <span class="n">iz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">botlist</span><span class="p">:</span>
                <span class="n">iz</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
                <span class="n">iz</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pos</span> <span class="o">/</span> <span class="n">sy</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;&quot;pos&quot; must be either float or &quot;top&quot;, &quot;bottom&quot;, &quot;left&quot; or &quot;right&quot;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">iz</span> <span class="o">*</span> <span class="n">sz</span><span class="p">)</span>
            <span class="n">xl</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;x ($\mu$m)&#39;</span>
            <span class="n">yl</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;z ($\mu$m)&#39;</span>
            <span class="n">title</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;XZ slice at y=</span><span class="si">{}</span><span class="s1"> $\mu$m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">iz</span> <span class="o">*</span> <span class="n">sz</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">cut</span> <span class="o">==</span> <span class="s1">&#39;yz&#39;</span><span class="p">:</span>
            <span class="n">sizeX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">sizeY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">vox_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
            <span class="n">sx</span> <span class="o">=</span> <span class="n">vox_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sy</span> <span class="o">=</span> <span class="n">vox_res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">sz</span> <span class="o">=</span> <span class="n">vox_res</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">iy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">toplist</span><span class="p">:</span>
                <span class="n">iz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">botlist</span><span class="p">:</span>
                <span class="n">iz</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
                <span class="n">iz</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pos</span> <span class="o">/</span> <span class="n">sx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;&quot;pos&quot; must be either float or &quot;top&quot;, &quot;bottom&quot;, &quot;left&quot; or &quot;right&quot;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">iz</span> <span class="o">*</span> <span class="n">sz</span><span class="p">)</span>
            <span class="n">xl</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;y ($\mu$m)&#39;</span>
            <span class="n">yl</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;z ($\mu$m)&#39;</span>
            <span class="n">title</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;YZ slice at x=</span><span class="si">{}</span><span class="s1"> $\mu$m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">iz</span> <span class="o">*</span> <span class="n">sz</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;&quot;cut&quot; must bei either &quot;xy&quot;, &quot;xz&quot; or &quot;yz&quot;.&#39;</span><span class="p">)</span>
        <span class="c1"># ANG file header</span>
        <span class="n">head</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;# TEM_PIXperUM          1.000000</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;# x-star                0.000000</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;# y-star                0.000000</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;# z-star                0.000000</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;# WorkingDistance       0.000000</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;#</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;# Phase 0</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;# MaterialName  	</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">matname</span><span class="p">),</span>
                <span class="s1">&#39;# Formula</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;# Info</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;# Symmetry              m-3m</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;# LatticeConstants       4.050 4.050 4.050  90.000  90.000  90.000</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;# NumberFamilies        0</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;# ElasticConstants 	0.000000 0.000000 0.000000 0.000000 0.000000 0.000000</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;# ElasticConstants 	0.000000 0.000000 0.000000 0.000000 0.000000 0.000000</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;# ElasticConstants 	0.000000 0.000000 0.000000 0.000000 0.000000 0.000000</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;# ElasticConstants 	0.000000 0.000000 0.000000 0.000000 0.000000 0.000000</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;# ElasticConstants 	0.000000 0.000000 0.000000 0.000000 0.000000 0.000000</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;# ElasticConstants 	0.000000 0.000000 0.000000 0.000000 0.000000 0.000000</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;# Categories0 0 0 0 0</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;# </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;# GRID: SqrGrid</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;# XSTEP: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="mi">6</span><span class="p">)),</span>
                <span class="s1">&#39;# YSTEP: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">sy</span><span class="p">,</span> <span class="mi">6</span><span class="p">)),</span>
                <span class="s1">&#39;# NCOLS_ODD: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ix</span><span class="p">),</span>
                <span class="s1">&#39;# NCOLS_EVEN: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ix</span><span class="p">),</span>
                <span class="s1">&#39;# NROWS: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iy</span><span class="p">),</span>
                <span class="s1">&#39;#</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;# OPERATOR: 	Administrator</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;#</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;# SAMPLEID:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;#</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;# SCANID:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;#</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="p">]</span>

        <span class="c1"># determine whether polygons or voxels shall be exported</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;Grains&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;poly&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">voxels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Neither polygons nor voxels for grains are present.</span><span class="se">\</span>
<span class="s1">                                 </span><span class="se">\n</span><span class="s1">Run voxelize and generate_grains first.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;voxels&#39;</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="o">!=</span> <span class="s1">&#39;voxels&#39;</span> <span class="ow">and</span> <span class="n">data</span> <span class="o">!=</span> <span class="s1">&#39;poly&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;&quot;data&quot; must be either &quot;voxels&quot; or &quot;poly&quot;.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s1">&#39;voxels&#39;</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">+=</span> <span class="s1">&#39; (Voxels)&#39;</span>
            <span class="k">if</span> <span class="n">cut</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span>
                <span class="n">g_slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grains</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">iz</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cut</span> <span class="o">==</span> <span class="s1">&#39;xz&#39;</span><span class="p">:</span>
                <span class="n">g_slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grains</span><span class="p">[:,</span> <span class="n">iz</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g_slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grains</span><span class="p">[</span><span class="n">iz</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dual_phase</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cut</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span>
                    <span class="n">g_slice_phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">phases</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">iz</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">cut</span> <span class="o">==</span> <span class="s1">&#39;xz&#39;</span><span class="p">:</span>
                    <span class="n">g_slice_phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">phases</span><span class="p">[:,</span> <span class="n">iz</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">g_slice_phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">phases</span><span class="p">[</span><span class="n">iz</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">+=</span> <span class="s1">&#39; (Polygons)&#39;</span>
            <span class="n">xv</span><span class="p">,</span> <span class="n">yv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">ix</span> <span class="o">*</span> <span class="n">sx</span><span class="p">,</span> <span class="n">iy</span> <span class="o">*</span> <span class="n">sy</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
            <span class="n">grain_slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">iy</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cut</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span>
                <span class="n">mesh_slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xv</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">yv</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">grain_slice</span> <span class="o">*</span> <span class="n">iz</span> <span class="o">*</span> <span class="n">sz</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="k">elif</span> <span class="n">cut</span> <span class="o">==</span> <span class="s1">&#39;xz&#39;</span><span class="p">:</span>
                <span class="n">mesh_slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xv</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">grain_slice</span> <span class="o">*</span> <span class="n">iz</span> <span class="o">*</span> <span class="n">sz</span><span class="p">,</span> <span class="n">yv</span><span class="o">.</span><span class="n">flatten</span><span class="p">()])</span><span class="o">.</span><span class="n">T</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mesh_slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">grain_slice</span> <span class="o">*</span> <span class="n">iz</span> <span class="o">*</span> <span class="n">sz</span><span class="p">,</span> <span class="n">xv</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">yv</span><span class="o">.</span><span class="n">flatten</span><span class="p">()])</span><span class="o">.</span><span class="n">T</span>
            <span class="n">grain_slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">iy</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">igr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="s1">&#39;Grains&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="s1">&#39;Grains&#39;</span><span class="p">][</span><span class="n">igr</span><span class="p">][</span><span class="s1">&#39;Points&#39;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tri</span> <span class="o">=</span> <span class="n">Delaunay</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">tri</span><span class="o">.</span><span class="n">find_simplex</span><span class="p">(</span><span class="n">mesh_slice</span><span class="p">)</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">grain_slice</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">igr</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;An unexpected exception occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Grain #</span><span class="si">{}</span><span class="s1"> has no convex hull (Nvertices: </span><span class="si">{}</span><span class="s1">)&#39;</span>
                                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">igr</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">grain_slice</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">grain_slice</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Incomplete slicing for </span><span class="si">{}</span><span class="s1"> pixels in </span><span class="si">{}</span><span class="s1"> slice at </span><span class="si">{}</span><span class="s1">.&#39;</span>
                              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">),</span> <span class="n">cut</span><span class="p">,</span> <span class="n">pos</span><span class="p">))</span>
            <span class="n">g_slice</span> <span class="o">=</span> <span class="n">grain_slice</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xv</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ori</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ori</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Ngr</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
                <span class="n">ori</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ngr</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                <span class="n">ori</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ngr</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                <span class="n">ori</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ngr</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="c1"># write data to ang file</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_slice_</span><span class="si">{1}</span><span class="s1">_</span><span class="si">{2}</span><span class="s1">.ang&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cut</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">pos</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">head</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">iy</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ix</span><span class="p">:</span>
                        <span class="n">p1</span> <span class="o">=</span> <span class="n">ori</span><span class="p">[</span><span class="n">g_slice</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                        <span class="n">P</span> <span class="o">=</span> <span class="n">ori</span><span class="p">[</span><span class="n">g_slice</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="n">p2</span> <span class="o">=</span> <span class="n">ori</span><span class="p">[</span><span class="n">g_slice</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{0}</span><span class="s1">  </span><span class="si">{1}</span><span class="s1">  </span><span class="si">{2}</span><span class="s1">  </span><span class="si">{3}</span><span class="s1">  </span><span class="si">{4}</span><span class="s1">   0.0  0.000  0   1  0.000</span><span class="se">\n</span><span class="s1">&#39;</span>
                                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
                                        <span class="nb">round</span><span class="p">(</span><span class="n">sizeX</span> <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="n">sx</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">sizeY</span> <span class="o">-</span> <span class="n">j</span> <span class="o">*</span> <span class="n">sy</span><span class="p">,</span> <span class="mi">5</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="c1"># plot grains on slice</span>
            <span class="c1"># cmap = plt.cm.get_cmap(&#39;gist_rainbow&#39;)</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;prism&#39;</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">g_slice</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                      <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">sizeX</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sizeY</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="n">xl</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">yl</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">save_plot</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">dual_phase</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">g_slice_phase</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                          <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">sizeX</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sizeY</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="n">xl</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">yl</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">save_plot</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fname</span></div>


<div class="viewcode-block" id="Microstructure.write_stl">
<a class="viewcode-back" href="../../../kanapy.html#kanapy.core.api.Microstructure.write_stl">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_stl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s1">&#39;grains&#39;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span>
                  <span class="n">phases</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">phase_num</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Write triangles of convex polyhedra forming grains in form of STL</span>
<span class="sd">        files in the format</span>
<span class="sd">        &#39;</span>
<span class="sd">        solid name</span>
<span class="sd">          facet normal n1 n2 n3</span>
<span class="sd">            outer loop</span>
<span class="sd">              vertex p1x p1y p1z</span>
<span class="sd">              vertex p2x p2y p2z</span>
<span class="sd">              vertex p3x p3y p3z</span>
<span class="sd">            endloop</span>
<span class="sd">          endfacet</span>
<span class="sd">        endsolid name</span>
<span class="sd">        &#39;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">write_facet</span><span class="p">(</span><span class="n">nv</span><span class="p">,</span> <span class="n">pts</span><span class="p">,</span> <span class="n">ft</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">nv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.e-5</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Acute facet detected. Facet: </span><span class="si">{</span><span class="n">ft</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">nv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">nv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.e-5</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Irregular facet detected. Facet: </span><span class="si">{</span><span class="n">ft</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">nv</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">nv</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; facet normal </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nv</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; outer loop</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   vertex </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   vertex </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   vertex </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  endloop</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; endfacet</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">write_grains</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">ft</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="s1">&#39;Facets&#39;</span><span class="p">]:</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="s1">&#39;Points&#39;</span><span class="p">][</span><span class="n">ft</span><span class="p">]</span>
                <span class="n">nv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># facet normal</span>
                <span class="n">write_facet</span><span class="p">(</span><span class="n">nv</span><span class="p">,</span> <span class="n">pts</span><span class="p">,</span> <span class="n">ft</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">write_phases</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">grain</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="s1">&#39;Grains&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">grain</span><span class="p">[</span><span class="s1">&#39;Phase&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ip</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ft</span> <span class="ow">in</span> <span class="n">grain</span><span class="p">[</span><span class="s1">&#39;Simplices&#39;</span><span class="p">]:</span>
                        <span class="n">pts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="s1">&#39;Points&#39;</span><span class="p">][</span><span class="n">ft</span><span class="p">]</span>
                        <span class="n">nv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># facet normal</span>
                        <span class="n">write_facet</span><span class="p">(</span><span class="n">nv</span><span class="p">,</span> <span class="n">pts</span><span class="p">,</span> <span class="n">ft</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">write_particles</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">pa</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ft</span> <span class="ow">in</span> <span class="n">pa</span><span class="o">.</span><span class="n">inner</span><span class="o">.</span><span class="n">convex_hull</span><span class="p">:</span>
                    <span class="n">pts</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">inner</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">ft</span><span class="p">]</span>
                    <span class="n">nv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># facet normal</span>
                    <span class="n">write_facet</span><span class="p">(</span><span class="n">nv</span><span class="p">,</span> <span class="n">pts</span><span class="p">,</span> <span class="n">ft</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Microstructure&#39;</span><span class="p">:</span>
                <span class="n">file</span> <span class="o">=</span> <span class="s1">&#39;px_</span><span class="si">{}</span><span class="s1">grains.stl&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ngr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.stl&#39;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;solid </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">data</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;particles&#39;</span><span class="p">,</span> <span class="s1">&#39;pa&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">inner</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Particles don&#39;t contain inner polyhedron, cannot write STL file.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">pa</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">:</span>
                        <span class="n">pa</span><span class="o">.</span><span class="n">sync_poly</span><span class="p">()</span>
                    <span class="n">write_particles</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">phases</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">phase_num</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Phase-specific output requested, but no phase number specified.&#39;</span><span class="p">)</span>
                    <span class="n">write_phases</span><span class="p">(</span><span class="n">phase_num</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">write_grains</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;endsolid</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="Microstructure.write_centers">
<a class="viewcode-back" href="../../../kanapy.html#kanapy.core.api.Microstructure.write_centers">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_centers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span> <span class="n">grains</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write grain center positions into CSV file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Microstructure&#39;</span><span class="p">:</span>
                <span class="n">file</span> <span class="o">=</span> <span class="s1">&#39;px_</span><span class="si">{}</span><span class="s1">grains_centroid.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ngr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_centroid.csv&#39;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">grains</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">grains</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="s1">&#39;Grains&#39;</span><span class="p">]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">gr</span> <span class="ow">in</span> <span class="n">grains</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="c1"># if polyhedral grain has no simplices, center should not be written!!!</span>
                <span class="n">ctr</span> <span class="o">=</span> <span class="n">gr</span><span class="p">[</span><span class="s1">&#39;Center&#39;</span><span class="p">]</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ctr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ctr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ctr</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="Microstructure.write_ori">
<a class="viewcode-back" href="../../../kanapy.html#kanapy.core.api.Microstructure.write_ori">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_ori</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Microstructure&#39;</span><span class="p">:</span>
                <span class="n">file</span> <span class="o">=</span> <span class="s1">&#39;px_</span><span class="si">{}</span><span class="s1">grains_ori.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ngr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_ori.csv&#39;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">angles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grain_ori_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No grain orientations given or stored.&#39;</span><span class="p">)</span>
            <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grain_ori_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ori</span> <span class="ow">in</span> <span class="n">angles</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ori</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ori</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ori</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="Microstructure.write_voxels">
<a class="viewcode-back" href="../../../kanapy.html#kanapy.core.api.Microstructure.write_voxels">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_voxels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">script_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span>
                     <span class="n">mesh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write voxel structure into JSON file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        angles</span>
<span class="sd">        script_name</span>
<span class="sd">        file</span>
<span class="sd">        path</span>
<span class="sd">        mesh</span>
<span class="sd">        source</span>
<span class="sd">        system</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">import</span><span class="w"> </span><span class="nn">platform</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">getpass</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">date</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">kanapy</span><span class="w"> </span><span class="kn">import</span> <span class="n">__version__</span>

        <span class="k">if</span> <span class="n">script_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">script_name</span> <span class="o">=</span> <span class="vm">__file__</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Microstructure&#39;</span><span class="p">:</span>
                <span class="n">file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;px_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Ngr</span><span class="si">}</span><span class="s1">grains_voxels.json&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_voxels.json&#39;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Writing voxel information of microstructure to </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="c1"># metadata</span>
        <span class="n">today</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">())</span>  <span class="c1"># date</span>
        <span class="n">owner</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>  <span class="c1"># username</span>
        <span class="n">sys_info</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">uname</span><span class="p">()</span>  <span class="c1"># system information</span>
        <span class="c1"># output dict</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Info&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;Owner&quot;</span><span class="p">:</span> <span class="n">owner</span><span class="p">,</span>
                <span class="s2">&quot;Institution&quot;</span><span class="p">:</span> <span class="s2">&quot;ICAMS, Ruhr University Bochum, Germany&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Date&quot;</span><span class="p">:</span> <span class="n">today</span><span class="p">,</span>
                <span class="s2">&quot;Description&quot;</span><span class="p">:</span> <span class="s2">&quot;Voxels of microstructure&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Method&quot;</span><span class="p">:</span> <span class="s2">&quot;Synthetic microstructure generator Kanapy&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;Model&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;Creator&quot;</span><span class="p">:</span> <span class="s2">&quot;kanapy&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Version&quot;</span><span class="p">:</span> <span class="n">__version__</span><span class="p">,</span>
                <span class="s2">&quot;Repository&quot;</span><span class="p">:</span> <span class="s2">&quot;https://github.com/ICAMS/Kanapy.git&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Input&quot;</span><span class="p">:</span> <span class="n">source</span><span class="p">,</span>
                <span class="s2">&quot;Script&quot;</span><span class="p">:</span> <span class="n">script_name</span><span class="p">,</span>
                <span class="s2">&quot;Material&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;Phase_names&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">phase_names</span><span class="p">,</span>
                <span class="s2">&quot;Size&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">size</span><span class="p">],</span>
                <span class="s2">&quot;Periodicity&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">periodic</span><span class="p">),</span>
                <span class="s2">&quot;Units&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;Length&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">},</span>
            <span class="s2">&quot;Data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;Description&quot;</span><span class="p">:</span> <span class="s1">&#39;Grain numbers per voxel&#39;</span><span class="p">,</span>
                <span class="s2">&quot;Type&quot;</span><span class="p">:</span> <span class="s1">&#39;int&#39;</span><span class="p">,</span>
                <span class="s2">&quot;Shape&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span>
                <span class="s2">&quot;Order&quot;</span><span class="p">:</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span>
                <span class="s2">&quot;Values&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">flatten</span><span class="p">()],</span>
            <span class="p">},</span>
            <span class="s2">&quot;Grains&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;Description&quot;</span><span class="p">:</span> <span class="s2">&quot;Grain-related data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Orientation&quot;</span><span class="p">:</span> <span class="s2">&quot;Euler-Bunge angle&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Phase&quot;</span><span class="p">:</span> <span class="s2">&quot;Phase number&quot;</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">system</span><span class="p">:</span>
            <span class="n">structure</span><span class="p">[</span><span class="s2">&quot;Info&quot;</span><span class="p">][</span><span class="s2">&quot;System&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;sysname&quot;</span><span class="p">:</span> <span class="n">sys_info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;nodename&quot;</span><span class="p">:</span> <span class="n">sys_info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="s2">&quot;release&quot;</span><span class="p">:</span> <span class="n">sys_info</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">sys_info</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                <span class="s2">&quot;machine&quot;</span><span class="p">:</span> <span class="n">sys_info</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="k">for</span> <span class="n">igr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grain_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">structure</span><span class="p">[</span><span class="s2">&quot;Grains&quot;</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">igr</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;Phase&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grain_phase_dict</span><span class="p">[</span><span class="n">igr</span><span class="p">])</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="n">angles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grain_ori_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No angles for grains are given. Writing only geometry of RVE.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">igr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grain_ori_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">structure</span><span class="p">[</span><span class="s2">&quot;Grains&quot;</span><span class="p">][</span><span class="n">igr</span><span class="p">][</span><span class="s2">&quot;Orientation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grain_ori_dict</span><span class="p">[</span><span class="n">igr</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">igr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">grain_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">structure</span><span class="p">[</span><span class="s2">&quot;Grains&quot;</span><span class="p">][</span><span class="n">igr</span><span class="p">][</span><span class="s2">&quot;Orientation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
        <span class="k">if</span> <span class="n">mesh</span><span class="p">:</span>
            <span class="n">structure</span><span class="p">[</span><span class="s1">&#39;Mesh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;Nodes&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;Description&quot;</span><span class="p">:</span> <span class="s1">&#39;Nodal coordinates&#39;</span><span class="p">,</span>
                    <span class="s2">&quot;Type&quot;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
                    <span class="s2">&quot;Shape&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                    <span class="s2">&quot;Values&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span><span class="p">],</span>
                <span class="p">},</span>
                <span class="s2">&quot;Voxels&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;Description&quot;</span><span class="p">:</span> <span class="s1">&#39;Node list per voxel&#39;</span><span class="p">,</span>
                    <span class="s2">&quot;Type&quot;</span><span class="p">:</span> <span class="s1">&#39;int&#39;</span><span class="p">,</span>
                    <span class="s2">&quot;Shape&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">voxel_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="mi">8</span><span class="p">),</span>
                    <span class="s2">&quot;Values&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">voxel_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span>
                <span class="p">}</span>
            <span class="p">}</span>

        <span class="c1"># write file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="Microstructure.write_dataSchema">
<a class="viewcode-back" href="../../../kanapy.html#kanapy.core.api.Microstructure.write_dataSchema">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_dataSchema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                         <span class="n">user_metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">boundary_condition</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">phases</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">interactive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                         <span class="n">structured</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                         <span class="n">ialloy</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                         <span class="n">length_unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;µm&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a JSON file containing User-, System-, and Job-Specific Elements.</span>

<span class="sd">        - `user_metadata`: prefilled metadata fields (if interactive=False).</span>
<span class="sd">        - `boundary_condition`: separate BC dict (mechanical_BC or thermal_BC).</span>
<span class="sd">        - `interactive`: if True and inputs missing, prompt user.</span>
<span class="sd">        - `structured`: whether mesh is structured.</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="c1"># interpret length_unit argument</span>
        <span class="k">if</span> <span class="n">length_unit</span> <span class="o">==</span> <span class="s1">&#39;µm&#39;</span><span class="p">:</span>
            <span class="n">length_scale</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">elif</span> <span class="n">length_unit</span> <span class="o">==</span> <span class="s1">&#39;mm&#39;</span><span class="p">:</span>
            <span class="n">length_scale</span> <span class="o">=</span> <span class="mf">1e-3</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;length_unit must be &#39;µm&#39; or &#39;mm&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># Material library definitions (pulled from mod_alloys.f)</span>
        <span class="n">material_library</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">1</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># Aluminum</span>
                <span class="s1">&#39;ialloy&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;material_identifier&#39;</span><span class="p">:</span> <span class="s1">&#39;Aluminum&#39;</span><span class="p">,</span>
                <span class="s1">&#39;elastic_model_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Anisotropic Elasticity&#39;</span><span class="p">,</span>
                <span class="s1">&#39;elastic_parameters&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;C11&#39;</span><span class="p">:</span> <span class="mf">247000.0</span><span class="p">,</span> <span class="s1">&#39;C12&#39;</span><span class="p">:</span> <span class="mf">147000.0</span><span class="p">,</span> <span class="s1">&#39;C44&#39;</span><span class="p">:</span> <span class="mf">125000.0</span>
                <span class="p">},</span>
                <span class="s1">&#39;plastic_model_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Crystal Plasticity&#39;</span><span class="p">,</span>
                <span class="s1">&#39;plastic_parameters&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;reference_shear_rate&#39;</span><span class="p">:</span> <span class="mf">1e-6</span><span class="p">,</span>  <span class="c1"># shrt0</span>
                    <span class="s1">&#39;initial_critical_resolved_shear_stress&#39;</span><span class="p">:</span> <span class="mf">20.0</span><span class="p">,</span>  <span class="c1"># crss0</span>
                    <span class="s1">&#39;saturated_slip_resistance&#39;</span><span class="p">:</span> <span class="mf">1500.0</span><span class="p">,</span>  <span class="c1"># crsss</span>
                    <span class="s1">&#39;strain_rate_sensitivity_exponent&#39;</span><span class="p">:</span> <span class="mf">20.0</span><span class="p">,</span>  <span class="c1"># pwfl</span>
                    <span class="s1">&#39;reference_hardening_rate&#39;</span><span class="p">:</span> <span class="mf">60.0</span><span class="p">,</span>  <span class="c1"># hdrt0</span>
                    <span class="s1">&#39;hardening_exponent&#39;</span><span class="p">:</span> <span class="mf">2.25</span>  <span class="c1"># pwhd</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="mi">2</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># Copper</span>
                <span class="s1">&#39;ialloy&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s1">&#39;material_identifier&#39;</span><span class="p">:</span> <span class="s1">&#39;Copper&#39;</span><span class="p">,</span>
                <span class="s1">&#39;elastic_model_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Anisotropic Elasticity&#39;</span><span class="p">,</span>
                <span class="s1">&#39;elastic_parameters&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;C11&#39;</span><span class="p">:</span> <span class="mf">170000.0</span><span class="p">,</span> <span class="s1">&#39;C12&#39;</span><span class="p">:</span> <span class="mf">124000.0</span><span class="p">,</span> <span class="s1">&#39;C44&#39;</span><span class="p">:</span> <span class="mf">75000.0</span>
                <span class="p">},</span>
                <span class="s1">&#39;plastic_model_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Crystal Plasticity&#39;</span><span class="p">,</span>
                <span class="s1">&#39;plastic_parameters&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;reference_shear_rate&#39;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span>  <span class="c1"># shrt0</span>
                    <span class="s1">&#39;initial_critical_resolved_shear_stress&#39;</span><span class="p">:</span> <span class="mf">16.0</span><span class="p">,</span>  <span class="c1"># crss0</span>
                    <span class="s1">&#39;saturated_slip_resistance&#39;</span><span class="p">:</span> <span class="mf">148.0</span><span class="p">,</span>  <span class="c1"># crsss</span>
                    <span class="s1">&#39;strain_rate_sensitivity_exponent&#39;</span><span class="p">:</span> <span class="mf">83.0</span><span class="p">,</span>  <span class="c1"># pwfl</span>
                    <span class="s1">&#39;reference_hardening_rate&#39;</span><span class="p">:</span> <span class="mf">250.0</span><span class="p">,</span>  <span class="c1"># hdrt0</span>
                    <span class="s1">&#39;hardening_exponent&#39;</span><span class="p">:</span> <span class="mf">2.25</span>  <span class="c1"># pwhd</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="mi">3</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># Ferrite</span>
                <span class="s1">&#39;ialloy&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                <span class="s1">&#39;material_identifier&#39;</span><span class="p">:</span> <span class="s1">&#39;Ferrite&#39;</span><span class="p">,</span>
                <span class="s1">&#39;elastic_model_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Anisotropic Elasticity&#39;</span><span class="p">,</span>
                <span class="s1">&#39;elastic_parameters&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;C11&#39;</span><span class="p">:</span> <span class="mf">230000.0</span><span class="p">,</span> <span class="s1">&#39;C12&#39;</span><span class="p">:</span> <span class="mf">135000.0</span><span class="p">,</span> <span class="s1">&#39;C44&#39;</span><span class="p">:</span> <span class="mf">116000.0</span>
                <span class="p">},</span>
                <span class="s1">&#39;plastic_model_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Crystal Plasticity&#39;</span><span class="p">,</span>
                <span class="s1">&#39;plastic_parameters&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;reference_shear_rate&#39;</span><span class="p">:</span> <span class="mf">1e-6</span><span class="p">,</span>
                    <span class="s1">&#39;initial_critical_resolved_shear_stress&#39;</span><span class="p">:</span> <span class="mf">25.0</span><span class="p">,</span>
                    <span class="s1">&#39;saturated_slip_resistance&#39;</span><span class="p">:</span> <span class="mf">1600.0</span><span class="p">,</span>
                    <span class="s1">&#39;strain_rate_sensitivity_exponent&#39;</span><span class="p">:</span> <span class="mf">18.0</span><span class="p">,</span>
                    <span class="s1">&#39;reference_hardening_rate&#39;</span><span class="p">:</span> <span class="mf">70.0</span><span class="p">,</span>
                    <span class="s1">&#39;hardening_exponent&#39;</span><span class="p">:</span> <span class="mf">2.0</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="mi">4</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># Austenite</span>
                <span class="s1">&#39;ialloy&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                <span class="s1">&#39;material_identifier&#39;</span><span class="p">:</span> <span class="s1">&#39;Austenite&#39;</span><span class="p">,</span>
                <span class="s1">&#39;elastic_model_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Anisotropic Elasticity&#39;</span><span class="p">,</span>
                <span class="s1">&#39;elastic_parameters&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;C11&#39;</span><span class="p">:</span> <span class="mf">190000.0</span><span class="p">,</span> <span class="s1">&#39;C12&#39;</span><span class="p">:</span> <span class="mf">130000.0</span><span class="p">,</span> <span class="s1">&#39;C44&#39;</span><span class="p">:</span> <span class="mf">115000.0</span>
                <span class="p">},</span>
                <span class="s1">&#39;plastic_model_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Crystal Plasticity&#39;</span><span class="p">,</span>
                <span class="s1">&#39;plastic_parameters&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;reference_shear_rate&#39;</span><span class="p">:</span> <span class="mf">1e-6</span><span class="p">,</span>
                    <span class="s1">&#39;initial_critical_resolved_shear_stress&#39;</span><span class="p">:</span> <span class="mf">15.0</span><span class="p">,</span>
                    <span class="s1">&#39;saturated_slip_resistance&#39;</span><span class="p">:</span> <span class="mf">1400.0</span><span class="p">,</span>
                    <span class="s1">&#39;strain_rate_sensitivity_exponent&#39;</span><span class="p">:</span> <span class="mf">22.0</span><span class="p">,</span>
                    <span class="s1">&#39;reference_hardening_rate&#39;</span><span class="p">:</span> <span class="mf">65.0</span><span class="p">,</span>
                    <span class="s1">&#39;hardening_exponent&#39;</span><span class="p">:</span> <span class="mf">2.2</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="mi">5</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># Superalloy</span>
                <span class="s1">&#39;ialloy&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                <span class="s1">&#39;material_identifier&#39;</span><span class="p">:</span> <span class="s1">&#39;Superalloy&#39;</span><span class="p">,</span>
                <span class="s1">&#39;elastic_model_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Anisotropic Elasticity&#39;</span><span class="p">,</span>
                <span class="s1">&#39;elastic_parameters&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;C11&#39;</span><span class="p">:</span> <span class="mf">260000.0</span><span class="p">,</span> <span class="s1">&#39;C12&#39;</span><span class="p">:</span> <span class="mf">150000.0</span><span class="p">,</span> <span class="s1">&#39;C44&#39;</span><span class="p">:</span> <span class="mf">120000.0</span>
                <span class="p">},</span>
                <span class="s1">&#39;plastic_model_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Crystal Plasticity&#39;</span><span class="p">,</span>
                <span class="s1">&#39;plastic_parameters&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;reference_shear_rate&#39;</span><span class="p">:</span> <span class="mf">1e-6</span><span class="p">,</span>
                    <span class="s1">&#39;initial_critical_resolved_shear_stress&#39;</span><span class="p">:</span> <span class="mf">30.0</span><span class="p">,</span>
                    <span class="s1">&#39;saturated_slip_resistance&#39;</span><span class="p">:</span> <span class="mf">1700.0</span><span class="p">,</span>
                    <span class="s1">&#39;strain_rate_sensitivity_exponent&#39;</span><span class="p">:</span> <span class="mf">25.0</span><span class="p">,</span>
                    <span class="s1">&#39;reference_hardening_rate&#39;</span><span class="p">:</span> <span class="mf">80.0</span><span class="p">,</span>
                    <span class="s1">&#39;hardening_exponent&#39;</span><span class="p">:</span> <span class="mf">2.8</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="mi">6</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># Nickel</span>
                <span class="s1">&#39;ialloy&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
                <span class="s1">&#39;material_identifier&#39;</span><span class="p">:</span> <span class="s1">&#39;Nickel&#39;</span><span class="p">,</span>
                <span class="s1">&#39;elastic_model_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Anisotropic Elasticity&#39;</span><span class="p">,</span>
                <span class="s1">&#39;elastic_parameters&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;C11&#39;</span><span class="p">:</span> <span class="mf">246000.0</span><span class="p">,</span> <span class="s1">&#39;C12&#39;</span><span class="p">:</span> <span class="mf">147000.0</span><span class="p">,</span> <span class="s1">&#39;C44&#39;</span><span class="p">:</span> <span class="mf">124000.0</span>
                <span class="p">},</span>
                <span class="s1">&#39;plastic_model_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Crystal Plasticity&#39;</span><span class="p">,</span>
                <span class="s1">&#39;plastic_parameters&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;reference_shear_rate&#39;</span><span class="p">:</span> <span class="mf">1e-6</span><span class="p">,</span>
                    <span class="s1">&#39;initial_critical_resolved_shear_stress&#39;</span><span class="p">:</span> <span class="mf">18.0</span><span class="p">,</span>
                    <span class="s1">&#39;saturated_slip_resistance&#39;</span><span class="p">:</span> <span class="mf">1450.0</span><span class="p">,</span>
                    <span class="s1">&#39;strain_rate_sensitivity_exponent&#39;</span><span class="p">:</span> <span class="mf">20.0</span><span class="p">,</span>
                    <span class="s1">&#39;reference_hardening_rate&#39;</span><span class="p">:</span> <span class="mf">75.0</span><span class="p">,</span>
                    <span class="s1">&#39;hardening_exponent&#39;</span><span class="p">:</span> <span class="mf">2.4</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1"># Define required fields</span>
        <span class="n">required_fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;identifier&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span>
            <span class="s1">&#39;creator&#39;</span><span class="p">,</span> <span class="s1">&#39;creator_ORCID&#39;</span><span class="p">,</span> <span class="s1">&#39;creator_affiliation&#39;</span><span class="p">,</span> <span class="s1">&#39;creator_institute&#39;</span><span class="p">,</span> <span class="s1">&#39;creator_group&#39;</span><span class="p">,</span>
            <span class="s1">&#39;contributor&#39;</span><span class="p">,</span> <span class="s1">&#39;contributor_ORCID&#39;</span><span class="p">,</span> <span class="s1">&#39;contributor_affiliation&#39;</span><span class="p">,</span> <span class="s1">&#39;contributor_institute&#39;</span><span class="p">,</span> <span class="s1">&#39;contributor_group&#39;</span><span class="p">,</span>
            <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;shared_with&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;rights&#39;</span><span class="p">,</span> <span class="s1">&#39;rights_holder&#39;</span><span class="p">,</span><span class="s1">&#39;funder_name&#39;</span><span class="p">,</span> <span class="s1">&#39;fund_identifier&#39;</span><span class="p">,</span>
            <span class="s1">&#39;publisher&#39;</span><span class="p">,</span> <span class="s1">&#39;relation&#39;</span><span class="p">,</span> <span class="s1">&#39;keywords&#39;</span>
        <span class="p">]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">prompt_list</span><span class="p">(</span><span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Enter comma-separated </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">: &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span> <span class="k">if</span> <span class="n">vals</span> <span class="k">else</span> <span class="p">[]</span>

        <span class="c1"># Gather metadata</span>
        <span class="k">if</span> <span class="n">interactive</span> <span class="ow">and</span> <span class="n">user_metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">use</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># identifier</span>
            <span class="n">ident</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Identifier (leave blank to auto-generate): &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ident</span><span class="p">:</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
                <span class="n">ident</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">8</span><span class="p">]</span>
            <span class="n">use</span><span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ident</span>
            <span class="n">use</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Title: &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># creator fields</span>
            <span class="n">use</span><span class="p">[</span><span class="s1">&#39;creator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prompt_list</span><span class="p">(</span><span class="s1">&#39;creator names (e.g. Last, First)&#39;</span><span class="p">)</span>
            <span class="n">use</span><span class="p">[</span><span class="s1">&#39;creator_ORCID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prompt_list</span><span class="p">(</span><span class="s1">&#39;creator ORCID(s)&#39;</span><span class="p">)</span>
            <span class="n">use</span><span class="p">[</span><span class="s1">&#39;creator_affiliation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prompt_list</span><span class="p">(</span><span class="s1">&#39;creator affiliations&#39;</span><span class="p">)</span>
            <span class="n">use</span><span class="p">[</span><span class="s1">&#39;creator_institute&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prompt_list</span><span class="p">(</span><span class="s1">&#39;creator institutes&#39;</span><span class="p">)</span>
            <span class="n">use</span><span class="p">[</span><span class="s1">&#39;creator_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prompt_list</span><span class="p">(</span><span class="s1">&#39;creator groups&#39;</span><span class="p">)</span>
            <span class="c1"># contributor fields</span>
            <span class="n">use</span><span class="p">[</span><span class="s1">&#39;contributor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prompt_list</span><span class="p">(</span><span class="s1">&#39;contributor names&#39;</span><span class="p">)</span>
            <span class="n">use</span><span class="p">[</span><span class="s1">&#39;contributor_ORCID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prompt_list</span><span class="p">(</span><span class="s1">&#39;contributor ORCID(s)&#39;</span><span class="p">)</span>
            <span class="n">use</span><span class="p">[</span><span class="s1">&#39;contributor_affiliation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prompt_list</span><span class="p">(</span><span class="s1">&#39;contributor affiliations&#39;</span><span class="p">)</span>
            <span class="n">use</span><span class="p">[</span><span class="s1">&#39;contributor_institute&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prompt_list</span><span class="p">(</span><span class="s1">&#39;contributor institutes&#39;</span><span class="p">)</span>
            <span class="n">use</span><span class="p">[</span><span class="s1">&#39;contributor_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prompt_list</span><span class="p">(</span><span class="s1">&#39;contributor groups&#39;</span><span class="p">)</span>

            <span class="n">use</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Date (YYYY-MM-DD): &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># shared_with</span>
            <span class="n">shared</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Enter shared_with access entries. Valid types: c, u, g, all. Blank to stop.&quot;</span><span class="p">)</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">atype</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;  access_type: &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">atype</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">shared</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;access_type&#39;</span><span class="p">:</span> <span class="n">atype</span><span class="p">})</span>
            <span class="n">use</span><span class="p">[</span><span class="s1">&#39;shared_with&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shared</span>
            <span class="n">use</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Description: &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">use</span><span class="p">[</span><span class="s1">&#39;rights&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Rights (e.g. Creative Commons Attribution 4.0 International): &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">use</span><span class="p">[</span><span class="s1">&#39;rights_holder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prompt_list</span><span class="p">(</span><span class="s1">&#39;rights_holder&#39;</span><span class="p">)</span>
            <span class="c1"># other fields</span>
            <span class="n">use</span><span class="p">[</span><span class="s1">&#39;funder_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Funder name: &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">use</span><span class="p">[</span><span class="s1">&#39;fund_identifier&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Fund identifier: &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">use</span><span class="p">[</span><span class="s1">&#39;publisher&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Publisher: &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">use</span><span class="p">[</span><span class="s1">&#39;relation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prompt_list</span><span class="p">(</span><span class="s1">&#39;relation (DOI or URL)&#39;</span><span class="p">)</span>
            <span class="n">use</span><span class="p">[</span><span class="s1">&#39;keywords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prompt_list</span><span class="p">(</span><span class="s1">&#39;keywords&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">user_metadata</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;user_metadata must be provided when interactive is False.&quot;</span><span class="p">)</span>
            <span class="n">use</span> <span class="o">=</span> <span class="n">user_metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># Validate presence of required fields</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">required_fields</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">use</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required metadata fields: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ig</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;RVE_size&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">*</span> <span class="n">length_scale</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">size</span><span class="p">],</span>
            <span class="s1">&#39;RVE_continuity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">periodic</span><span class="p">,</span>
            <span class="s1">&#39;discretization_type&#39;</span><span class="p">:</span> <span class="s1">&#39;Structured&#39;</span> <span class="k">if</span> <span class="n">structured</span> <span class="k">else</span> <span class="s1">&#39;Unstructured&#39;</span><span class="p">,</span>
            <span class="s1">&#39;discretization_unit_size&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">))</span> <span class="o">*</span> <span class="n">length_scale</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">dim</span><span class="p">)],</span>
            <span class="s1">&#39;discretization_count&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nvox</span><span class="p">),</span>
            <span class="s1">&#39;global_rotation_convention&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(),</span>
            <span class="s1">&#39;Origin&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;software&#39;</span><span class="p">:</span> <span class="s1">&#39;kanapy&#39;</span><span class="p">,</span>
                <span class="s1">&#39;software_version&#39;</span><span class="p">:</span> <span class="n">pkg_version</span><span class="p">(</span><span class="s1">&#39;kanapy&#39;</span><span class="p">),</span>
                <span class="s1">&#39;system&#39;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">(),</span>
                <span class="s1">&#39;system_version&#39;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">version</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1"># ─── Show vertex‐diagram for BC reference ────────────────────────────────</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># locate the package root, two levels up from this file</span>
            <span class="n">script_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
            <span class="n">project_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
            <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">project_root</span><span class="p">,</span> <span class="s1">&#39;docs&#39;</span><span class="p">,</span> <span class="s1">&#39;figs&#39;</span><span class="p">,</span> <span class="s1">&#39;RVE&#39;</span><span class="p">,</span> <span class="s1">&#39;Vertices.png&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">img_path</span><span class="p">):</span>
                <span class="c1"># first try with Pillow</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
                    <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                    <span class="c1"># fallback to the system browser/viewer</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">webbrowser</span>
                    <span class="n">webbrowser</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;file://</span><span class="si">{</span><span class="n">img_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Warning] Unable to open Vertices.png: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Boundary conditions</span>
        <span class="k">if</span> <span class="n">boundary_condition</span><span class="p">:</span>
            <span class="c1"># Ensure &#39;type&#39; is present</span>
            <span class="k">if</span> <span class="s1">&#39;mechanical_BC&#39;</span> <span class="ow">in</span> <span class="n">boundary_condition</span><span class="p">:</span>
                <span class="c1"># Determine mechanical vs thermal by key presence</span>
                <span class="n">mech_list</span> <span class="o">=</span> <span class="n">boundary_condition</span><span class="p">[</span><span class="s1">&#39;mechanical_BC&#39;</span><span class="p">]</span>
                <span class="c1"># Normalize to list</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mech_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">mech_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">mech_list</span><span class="p">]</span>
                <span class="n">job_bc</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mechanical_BC&#39;</span><span class="p">:</span> <span class="n">mech_list</span><span class="p">}</span>
            <span class="k">elif</span> <span class="s1">&#39;thermal_BC&#39;</span> <span class="ow">in</span> <span class="n">boundary_condition</span><span class="p">:</span>
                <span class="n">th_list</span> <span class="o">=</span> <span class="n">boundary_condition</span><span class="p">[</span><span class="s1">&#39;thermal_BC&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">th_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">th_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">th_list</span><span class="p">]</span>
                <span class="n">job_bc</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;thermal_BC&#39;</span><span class="p">:</span> <span class="n">th_list</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># fallback if wrong keys provided</span>
                <span class="k">if</span> <span class="n">interactive</span><span class="p">:</span>
                    <span class="c1"># ask user which type to populate</span>
                    <span class="n">bc_choice</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Boundary condition key not found. Enter &#39;mechanical&#39; or &#39;thermal&#39;: &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">bc_choice</span> <span class="o">==</span> <span class="s1">&#39;mechanical&#39;</span><span class="p">:</span>
                        <span class="n">job_bc</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mechanical_BC&#39;</span><span class="p">:</span> <span class="p">[]}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">job_bc</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;thermal_BC&#39;</span><span class="p">:</span> <span class="p">{}}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;boundary_condition dict must include &#39;mechanical_BC&#39; or &#39;thermal_BC&#39; key when interactive=False.&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">interactive</span><span class="p">:</span> <span class="c1"># Interactive entry of multiple mechanical BCs</span>
            <span class="n">mech_entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">bc_type</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Boundary condition type (&#39;mechanical&#39; or &#39;thermal&#39;): &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">bc_type</span> <span class="o">==</span> <span class="s1">&#39;mechanical&#39;</span><span class="p">:</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Define a mechanical BC (leave vertex_list blank to stop):&quot;</span><span class="p">)</span>
                    <span class="n">vertex_list</span> <span class="o">=</span> <span class="n">prompt_list</span><span class="p">(</span><span class="s1">&#39;vertex_list&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">vertex_list</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">constraints</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Constraints xyz (e.g. &#39;free,fixed,loaded&#39;): &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                    <span class="n">loading_type</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Loading type (force/displacement/stress/strain/none): &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">loading_mode</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Loading mode (static/cyclic/monotonic/intermittent): &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="c1"># count how many of those constraints are “loaded”:</span>
                    <span class="n">num</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">constraints</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;loaded&#39;</span><span class="p">)</span>
                    <span class="n">loads</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Load entry #</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
                        <span class="n">mag</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;  magnitude: &quot;</span><span class="p">))</span>
                        <span class="n">freq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;  frequency: &quot;</span><span class="p">))</span>
                        <span class="n">dur</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;  duration: &quot;</span><span class="p">))</span>
                        <span class="n">R</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;  R: &quot;</span><span class="p">))</span>
                        <span class="n">loads</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;magnitude&#39;</span><span class="p">:</span> <span class="n">mag</span><span class="p">,</span> <span class="s1">&#39;frequency&#39;</span><span class="p">:</span> <span class="n">freq</span><span class="p">,</span> <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="n">dur</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="n">R</span><span class="p">})</span>
                    <span class="n">mech_entries</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;vertex_list&#39;</span><span class="p">:</span> <span class="n">vertex_list</span><span class="p">,</span>
                        <span class="s1">&#39;constraints&#39;</span><span class="p">:</span> <span class="n">constraints</span><span class="p">,</span>
                        <span class="s1">&#39;loading_type&#39;</span><span class="p">:</span> <span class="n">loading_type</span><span class="p">,</span>
                        <span class="s1">&#39;loading_mode&#39;</span><span class="p">:</span> <span class="n">loading_mode</span><span class="p">,</span>
                        <span class="s1">&#39;applied_load&#39;</span><span class="p">:</span> <span class="n">loads</span>
                    <span class="p">})</span>
                <span class="n">job_bc</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mechanical_BC&#39;</span><span class="p">:</span> <span class="n">mech_entries</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">job_bc</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;thermal_BC&#39;</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">job_bc</span> <span class="o">=</span> <span class="p">{}</span>


        <span class="c1"># Phase data</span>
        <span class="n">phase_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">phases</span><span class="p">:</span>  <span class="c1"># user provided a dict or list of dicts</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phases</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">phase_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">phases</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phases</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">phase_list</span> <span class="o">=</span> <span class="n">phases</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;`phases` must be a dict or list of dicts.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># fallback: use ialloy + material_library</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ialloy</span> <span class="ow">or</span> <span class="n">ialloy</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">material_library</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">interactive</span><span class="p">:</span>
                    <span class="n">ialloy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Choose ialloy from </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">material_library</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">: &quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;No phases provided and invalid ialloy. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Valid ialloy values: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">material_library</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nphases</span><span class="p">):</span>
                <span class="n">phase_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">phase_names</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">vf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="o">.</span><span class="n">phase_vf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">mat</span> <span class="o">=</span> <span class="n">material_library</span><span class="p">[</span><span class="n">ialloy</span><span class="p">]</span>
                <span class="n">pe</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="s1">&#39;elastic_parameters&#39;</span><span class="p">]</span>
                <span class="n">pp</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="s1">&#39;plastic_parameters&#39;</span><span class="p">]</span>

                <span class="n">phase_entry</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">idx</span><span class="p">,</span>
                    <span class="s2">&quot;phase_identifier&quot;</span><span class="p">:</span> <span class="n">phase_name</span><span class="p">,</span>
                    <span class="s2">&quot;constitutive_model&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;$schema&quot;</span><span class="p">:</span> <span class="s2">&quot;http://json-schema.org/draft-04/schema#&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;elastic_model_name&quot;</span><span class="p">:</span> <span class="n">mat</span><span class="p">[</span><span class="s1">&#39;elastic_model_name&#39;</span><span class="p">],</span>
                        <span class="s2">&quot;elastic_parameters&quot;</span><span class="p">:</span> <span class="n">pe</span><span class="p">,</span>
                        <span class="s2">&quot;plastic_model_name&quot;</span><span class="p">:</span> <span class="n">mat</span><span class="p">[</span><span class="s1">&#39;plastic_model_name&#39;</span><span class="p">],</span>
                        <span class="s2">&quot;plastic_parameters&quot;</span><span class="p">:</span> <span class="n">pp</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;microstructural_information&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;phase_volume_fraction&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">vf</span><span class="p">),</span>
                        <span class="s2">&quot;grain_count&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngrains</span><span class="p">[</span><span class="n">idx</span><span class="p">]),</span>
                        <span class="s2">&quot;texture_type&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="s2">&quot;texture&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                        <span class="s2">&quot;lattice_structure&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="n">phase_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_entry</span><span class="p">)</span>

        <span class="c1"># ─── pull Mesh + RVE into locals ─────────────────────────────────────────</span>
        <span class="n">grain_phase_dict</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;grain_phase_dict&#39;</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{}</span> <span class="c1"># {gid: phase_id}</span>
        <span class="n">grain_ori_dict</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;grain_ori_dict&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># can be None ({gid: [euler…]})</span>
        <span class="n">vox_center_dict</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;vox_center_dict&#39;</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{}</span> <span class="c1"># {vid: (x,y,z)}</span>
        <span class="n">grain_to_voxels</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;grain_dict&#39;</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{}</span> <span class="c1"># {gid: [vid,…]}</span>
        <span class="n">rve_size</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="c1"># e.g. [20.0,20.0,20.0]</span>
        <span class="n">rve_dim</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rve</span><span class="p">,</span> <span class="s1">&#39;dim&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="ow">or</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># # e.g. [10,10,10] (avoid /0)</span>

        <span class="c1"># Is orientation available?</span>
        <span class="n">include_orientation</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">grain_ori_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">grain_ori_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="c1"># ─── compute one‐voxel volume ─────────────────────────────────────────────</span>
        <span class="n">unit_sizes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rve_size</span><span class="p">,</span> <span class="n">rve_dim</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">unit_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">))</span> <span class="o">*</span> <span class="n">length_scale</span> <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">unit_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="n">voxel_volume</span> <span class="o">=</span> <span class="p">(</span><span class="n">unit_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unit_sizes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">)</span> \
                       <span class="o">*</span> <span class="p">(</span><span class="n">unit_sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unit_sizes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">)</span> \
                       <span class="o">*</span> <span class="p">(</span><span class="n">unit_sizes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unit_sizes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="c1"># ─── precompute voxel→grain lookup ───────────────────────────────────────</span>
        <span class="n">voxel_to_grain</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">vid</span><span class="p">:</span> <span class="n">gid</span>
            <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">vids</span> <span class="ow">in</span> <span class="n">grain_to_voxels</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">vid</span> <span class="ow">in</span> <span class="n">vids</span>
        <span class="p">}</span>
        <span class="c1"># ─── build time‐0 grain dict ────────────────────────────────────────────</span>
        <span class="n">grains_t0</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">gid</span> <span class="ow">in</span> <span class="n">grain_phase_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;gid&quot;</span><span class="p">:</span> <span class="n">gid</span><span class="p">,</span>
                <span class="s2">&quot;phase_id&quot;</span><span class="p">:</span> <span class="n">grain_phase_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gid</span><span class="p">),</span>
                <span class="s2">&quot;grain_volume&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">grain_to_voxels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="p">[]))</span> <span class="o">*</span> <span class="n">voxel_volume</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">include_orientation</span><span class="p">:</span>
                <span class="n">ori</span> <span class="o">=</span> <span class="n">grain_ori_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ori</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;orientation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ori</span><span class="p">)</span>
            <span class="n">grains_t0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

        <span class="c1"># ─── Build time‐0 voxel dictionary ────────────────────────────────────────</span>
        <span class="n">voxels_t0</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vid</span><span class="p">,</span> <span class="n">gid</span> <span class="ow">in</span> <span class="n">voxel_to_grain</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">cz</span> <span class="o">=</span> <span class="n">vox_center_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;vid&quot;</span><span class="p">:</span> <span class="n">vid</span><span class="p">,</span>
                <span class="s2">&quot;grain_id&quot;</span><span class="p">:</span> <span class="n">gid</span><span class="p">,</span>
                <span class="s2">&quot;centroid_coordinates&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span> <span class="o">*</span> <span class="n">length_scale</span><span class="p">,</span>
                                         <span class="nb">float</span><span class="p">(</span><span class="n">cy</span><span class="p">)</span> <span class="o">*</span> <span class="n">length_scale</span><span class="p">,</span>
                                         <span class="nb">float</span><span class="p">(</span><span class="n">cz</span><span class="p">)</span> <span class="o">*</span> <span class="n">length_scale</span><span class="p">],</span>
                <span class="s2">&quot;voxel_volume&quot;</span><span class="p">:</span> <span class="n">voxel_volume</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">include_orientation</span><span class="p">:</span>
                <span class="n">ori</span> <span class="o">=</span> <span class="n">grain_ori_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ori</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;orientation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ori</span><span class="p">)</span>
            <span class="n">voxels_t0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

        <span class="c1"># ─── wrap under the time‐step keys ────────────────────────────────────────</span>
        <span class="n">time_steps</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>   <span class="s2">&quot;time&quot;</span>  <span class="p">:</span> <span class="mi">0</span>        <span class="p">,</span>
                <span class="s2">&quot;grains&quot;</span><span class="p">:</span> <span class="n">grains_t0</span><span class="p">,</span>
                <span class="s2">&quot;voxels&quot;</span><span class="p">:</span> <span class="n">voxels_t0</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="c1"># …etc…</span>
        <span class="p">]</span>



        <span class="c1"># Assemble final structure with placeholders</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="o">**</span><span class="n">use</span><span class="p">,</span>                   <span class="c1"># expand user-specific dict entries directly</span>
            <span class="s1">&#39;software&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;software_version&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;system&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;system_version&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;processor_specifications&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;input_path&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;results_path&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="o">**</span><span class="n">ig</span><span class="p">,</span>                    <span class="c1"># expand initial geometry dict entries directly</span>
            <span class="s1">&#39;global_temperature&#39;</span><span class="p">:</span> <span class="mi">298</span><span class="p">,</span>
            <span class="o">**</span><span class="n">job_bc</span><span class="p">,</span>                 <span class="c1"># expand boundary condition dict entries directly</span>
            <span class="s1">&#39;phases&#39;</span><span class="p">:</span><span class="n">phase_list</span><span class="p">,</span>
            <span class="s1">&#39;microstructure_evolution&#39;</span><span class="p">:</span>  <span class="n">time_steps</span>  <span class="c1"># Time-level storage: time-frame data of voxels and grains</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">data</span></div>






<div class="viewcode-block" id="Microstructure.pckl">
<a class="viewcode-back" href="../../../kanapy.html#kanapy.core.api.Microstructure.pckl">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pckl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write microstructure into pickle file. Usefull for to store complex structures.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file : string (optional, default: None)</span>
<span class="sd">            File name for pickled microstructure. The default is None, in which case</span>
<span class="sd">            the filename will be the microstructure name + &#39;.pckl&#39;.</span>
<span class="sd">        path : string</span>
<span class="sd">            Path to location for pickles</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>

        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Microstructure&#39;</span><span class="p">:</span>
                <span class="n">file</span> <span class="o">=</span> <span class="s1">&#39;px_</span><span class="si">{}</span><span class="s1">grains_microstructure.pckl&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ngr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_microstructure.pckl&#39;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="Microstructure.import_particles">
<a class="viewcode-back" href="../../../kanapy.html#kanapy.core.api.Microstructure.import_particles">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">import_particles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simbox</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span> <span class="o">=</span> <span class="n">read_dump</span><span class="p">(</span><span class="n">file</span><span class="p">)</span></div>


<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --------        legacy methods        --------</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Microstructure.init_stats">
<a class="viewcode-back" href="../../../kanapy.html#kanapy.core.api.Microstructure.init_stats">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">init_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">descriptor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gs_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ar_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">porous</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_files</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Legacy function for plot_stats_init.&quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;&quot;init_stats&quot; is a legacy function and will be depracted, please use &quot;plot_stats_init()&quot;.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_stats_init</span><span class="p">(</span><span class="n">descriptor</span><span class="p">,</span> <span class="n">gs_data</span><span class="o">=</span><span class="n">gs_data</span><span class="p">,</span> <span class="n">ar_data</span><span class="o">=</span><span class="n">ar_data</span><span class="p">,</span> <span class="n">save_files</span><span class="o">=</span><span class="n">save_files</span><span class="p">)</span></div>


<div class="viewcode-block" id="Microstructure.output_abq">
<a class="viewcode-back" href="../../../kanapy.html#kanapy.core.api.Microstructure.output_abq">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">output_abq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">voxel_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grain_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">faces</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">dual_phase</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">thermal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Legacy function for write_abq.&quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;&quot;output_abq&quot; is a legacy function and will be depracted, please use &quot;write_abq()&quot;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">faces</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Parameter &quot;faces&quot; will be determined automatically.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_abq</span><span class="p">(</span><span class="n">nodes</span><span class="o">=</span><span class="n">nodes</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">voxel_dict</span><span class="o">=</span><span class="n">voxel_dict</span><span class="p">,</span> <span class="n">grain_dict</span><span class="o">=</span><span class="n">grain_dict</span><span class="p">,</span>
                       <span class="n">dual_phase</span><span class="o">=</span><span class="n">dual_phase</span><span class="p">,</span> <span class="n">thermal</span><span class="o">=</span><span class="n">thermal</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright This work is published under a CC BY-SA 4.0 license.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>